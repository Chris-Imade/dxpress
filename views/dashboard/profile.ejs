<!-- Dashboard Profile -->
<div class="dashboard-card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-user-cog"></i>
        </div>
        <div>
            <div class="card-title">Profile Settings</div>
            <div class="card-subtitle">Manage your account information and preferences</div>
        </div>
    </div>
</div>

<!-- Profile Information -->
<div style="display: grid; grid-template-columns: 1fr 300px; gap: 24px;">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <div class="card-title">Personal Information</div>
                <div class="card-subtitle">Update your personal details</div>
            </div>
        </div>
        <form id="profileForm" style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">First Name *</label>
                    <input type="text" id="firstName" value="<%= user && user.name ? user.name.split(' ')[0] : '' %>" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Last Name *</label>
                    <input type="text" id="lastName" value="<%= user && user.name ? user.name.split(' ').slice(1).join(' ') : '' %>" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Email Address *</label>
                <input type="email" id="email" value="<%= user && user.email ? user.email : '' %>" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Phone Number</label>
                <input type="tel" id="phone" value="+1 (555) 123-4567" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Company</label>
                <input type="text" id="company" value="Acme Corporation" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Address</label>
                <textarea id="address" rows="3" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; resize: vertical;">123 Business St, New York, NY 10001</textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </form>
    </div>

    <!-- Profile Summary -->
    <div>
        <div class="dashboard-card" style="margin-bottom: 24px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; min-width: 80px; min-height: 80px; max-width: 80px; max-height: 80px; background: linear-gradient(135deg, #032330, #1a4c5a); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold; aspect-ratio: 1 / 1; flex-shrink: 0; overflow: hidden;">
                    <%= user && user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
                </div>
                <h3 style="margin: 0 0 4px 0; color: #032330;"><%= user && user.name ? user.name : 'User' %></h3>
                <p style="margin: 0; color: #6b7280; font-size: 14px;"><%= user && user.email ? user.email : 'user@example.com' %></p>
            </div>
            <div id="profileStats" style="padding: 16px; background: #f9fafb; border-radius: 10px;">
                <!-- Profile stats will be populated by JavaScript -->
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="dashboard-card" style="margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-icon" style="width: 32px; height: 32px; font-size: 14px;">
                    <i class="fas fa-bell"></i>
                </div>
                <div>
                    <div class="card-title" style="font-size: 16px;">Notifications</div>
                    <div class="card-subtitle">Manage notification preferences</div>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Notification Sounds</div>
                        <div style="font-size: 12px; color: #6b7280;">Play sound when new notifications arrive</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" onchange="toggleNotificationSound()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Test Sound</div>
                        <div style="font-size: 12px; color: #6b7280;">Preview notification sound</div>
                    </div>
                    <button class="btn btn-secondary" onclick="testNotificationSound()" style="padding: 8px 16px; font-size: 12px;">
                        <i class="fas fa-volume-up"></i>
                        Test
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-icon" style="width: 32px; height: 32px; font-size: 14px;">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div>
                    <div class="card-title" style="font-size: 16px;">Security</div>
                    <div class="card-subtitle">Account security settings</div>
                </div>
            </div>
            <div style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="changePassword()" style="width: 100%; margin-bottom: 12px;">
                    <i class="fas fa-key"></i>
                    Change Password
                </button>
                <button class="btn btn-secondary" onclick="enableTwoFactor()" style="width: 100%;">
                    <i class="fas fa-mobile-alt"></i>
                    Enable 2FA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="dashboard-card" style="margin-top: 24px;">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-bolt"></i>
        </div>
        <div>
            <div class="card-title">Quick Actions</div>
            <div class="card-subtitle">Common profile-related tasks</div>
        </div>
    </div>
    <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <button class="btn btn-outline-primary" onclick="viewNotifications()" style="padding: 16px; text-align: left;">
            <i class="fas fa-bell" style="margin-bottom: 8px; font-size: 20px;"></i>
            <div style="font-weight: 600;">View Notifications</div>
            <div style="font-size: 12px; opacity: 0.7;">Manage your alerts</div>
        </button>
        <button class="btn btn-outline-primary" onclick="viewInvoices()" style="padding: 16px; text-align: left;">
            <i class="fas fa-file-invoice" style="margin-bottom: 8px; font-size: 20px;"></i>
            <div style="font-weight: 600;">View Invoices</div>
            <div style="font-size: 12px; opacity: 0.7;">Billing & payments</div>
        </button>
        <button class="btn btn-outline-primary" onclick="viewShipments()" style="padding: 16px; text-align: left;">
            <i class="fas fa-box" style="margin-bottom: 8px; font-size: 20px;"></i>
            <div style="font-weight: 600;">My Shipments</div>
            <div style="font-size: 12px; opacity: 0.7;">Track packages</div>
        </button>
    </div>
</div>

<style>
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #032330;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

@media (max-width: 768px) {
    .dashboard-card:first-child {
        grid-column: 1 / -1;
    }
    
    .dashboard-card:first-child + div {
        grid-column: 1 / -1;
    }
}
</style>

<!-- Notification Sound Script -->
<script src="/assets/sounds/notification.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadProfileStats();
    initializeNotificationSettings();
    
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateProfile();
    });
});

// Safe localStorage wrapper
function getStorageItem(key, defaultValue = 'true') {
    try {
        if (typeof Storage !== 'undefined' && localStorage) {
            const value = localStorage.getItem(key);
            return value !== null ? value : defaultValue;
        }
    } catch (error) {
        console.warn('localStorage not available:', error);
    }
    return defaultValue;
}

function setStorageItem(key, value) {
    try {
        if (typeof Storage !== 'undefined' && localStorage) {
            localStorage.setItem(key, value);
            return true;
        }
    } catch (error) {
        console.warn('Failed to save to localStorage:', error);
    }
    return false;
}

// Initialize notification settings
function initializeNotificationSettings() {
    const soundEnabled = getStorageItem('notificationSoundEnabled', 'true') !== 'false';
    const toggle = document.getElementById('soundToggle');
    if (toggle) {
        toggle.checked = soundEnabled;
    }
}

// Save notification settings
async function saveNotificationSettings() {
    try {
        const soundEnabled = document.getElementById('notificationSound').checked;
        
        console.log('💾 Saving notification sound setting:', soundEnabled);
        
        // Save to localStorage with safe wrapper
        setStorageItem('notificationSound', soundEnabled.toString());
        
        // Also save to database via API
        const preferences = {
            notifications: {
                sound: soundEnabled,
                email: true, // Keep existing defaults
                push: true
            }
        };
        
        console.log('📡 Sending preferences to server:', preferences);
        
        const response = await fetch('/dashboard/api/preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ preferences })
        });
        
        const result = await response.json();
        console.log('📨 Server response:', result);
        
        if (result.success) {
            showToast('Notification settings saved successfully!', 'success');
        } else {
            throw new Error(result.message || 'Failed to save to database');
        }
        
    } catch (error) {
        console.error('Failed to save notification settings:', error);
        showToast('Failed to save settings. Please try again.', 'error');
    }
}

// Test notification sound
async function testNotificationSound() {
    console.log('Testing notification sound...');
    
    try {
        // Play MP3 notification sound
        const audio = new Audio('/assets/sounds/chime.mp3');
        audio.volume = 0.7;
        
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            await playPromise;
            showNotification('Notification sound test completed!', 'success');
        }
    } catch (error) {
        console.error('Test notification sound error:', error);
        if (error.name === 'NotAllowedError') {
            showNotification('Please interact with the page first, then try again', 'warning');
        } else {
            showNotification('Failed to play notification sound', 'error');
        }
    }
}

// Show notification feedback
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

function loadProfileStats() {
    // Load user shipments and invoices for stats
    Promise.all([
        fetch('/dashboard/api/shipments').then(r => r.json()),
        fetch('/dashboard/api/invoices').then(r => r.json())
    ]).then(([shipmentsData, invoicesData]) => {
        const shipments = shipmentsData.success ? shipmentsData.shipments : [];
        const invoices = invoicesData.success ? invoicesData.invoices : [];
        
        renderProfileStats(shipments, invoices);
    }).catch(error => {
        console.error('Error loading profile stats:', error);
        showEmptyProfileStats();
    });
}

function renderProfileStats(shipments, invoices) {
    const statsContainer = document.getElementById('profileStats');
    const memberSince = '<%= user && user.createdAt ? new Date(user.createdAt).toLocaleDateString("en-US", {month: "short", year: "numeric"}) : "Dec 2024" %>';
    
    statsContainer.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Member Since</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">${memberSince}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Total Shipments</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">${shipments.length}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Total Invoices</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">${invoices.length}</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span style="font-size: 14px; color: #6b7280;">Account Status</span>
            <span style="font-size: 12px; padding: 4px 8px; background: #d1fae5; color: #065f46; border-radius: 12px; font-weight: 600;">Active</span>
        </div>
    `;
}

function showEmptyProfileStats() {
    const statsContainer = document.getElementById('profileStats');
    const memberSince = '<%= user && user.createdAt ? new Date(user.createdAt).toLocaleDateString("en-US", {month: "short", year: "numeric"}) : "Dec 2024" %>';
    
    statsContainer.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Member Since</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">${memberSince}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Total Shipments</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">0</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 14px; color: #6b7280;">Total Invoices</span>
            <span style="font-size: 14px; font-weight: 600; color: #374151;">0</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span style="font-size: 14px; color: #6b7280;">Account Status</span>
            <span style="font-size: 12px; padding: 4px 8px; background: #d1fae5; color: #065f46; border-radius: 12px; font-weight: 600;">Active</span>
        </div>
    `;
}

function updateProfile() {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const company = document.getElementById('company').value;
    const address = document.getElementById('address').value;
    
    if (!firstName || !lastName || !email) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Simulate API call
    console.log('Updating profile:', {
        firstName, lastName, email, phone, company, address
    });
    
    showNotification('Profile updated successfully!', 'success');
}

function changePassword() {
    // This would open a password change modal
    showNotification('Password change feature coming soon', 'info');
}

function enableTwoFactor() {
    // This would open 2FA setup modal
    showNotification('Two-factor authentication setup coming soon', 'info');
}

function viewNotifications() {
    window.location.href = '/dashboard/notifications';
}

function viewInvoices() {
    window.location.href = '/dashboard/invoices';
}

function viewShipments() {
    window.location.href = '/dashboard/orders';
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
