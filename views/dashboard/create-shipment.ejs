<!-- Dashboard Shipment Creation -->
<div class="dashboard-card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <div>
            <div class="card-title">Create New Shipment</div>
            <div class="card-subtitle">Quick and easy shipment creation for logged-in users</div>
        </div>
        <div style="margin-left: auto;">
            <button class="btn btn-secondary" onclick="loadTemplate()">
                <i class="fas fa-file-import"></i>
                Load Template
            </button>
        </div>
    </div>
</div>

<!-- Shipment Form -->
<form id="shipmentForm" style="display: grid; gap: 24px;">
    <!-- Provider Selection -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-shipping-fast"></i>
            </div>
            <div>
                <div class="card-title">Shipping Provider</div>
                <div class="card-subtitle">Choose your preferred shipping carrier</div>
            </div>
        </div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <!-- FedEx - Active -->
            <div class="provider-option active" onclick="selectProvider('fedex')" data-provider="fedex">
                <input type="radio" name="shippingProvider" value="fedex" id="providerFedex" checked>
                <div class="provider-content">
                    <div class="provider-logo-img">
                        <img src="/assets/images/providers-logo/FedEx-Logo.webp" alt="FedEx" class="provider-image">
                    </div>
                    <div class="provider-info">
                        <div class="provider-name">FedEx</div>
                        <div class="provider-status active">‚úì Available</div>
                        <div class="provider-features">Express ‚Ä¢ Ground ‚Ä¢ International</div>
                    </div>
                </div>
            </div>
            
            <!-- DHL - Disabled -->
            <div class="provider-option disabled" data-provider="dhl">
                <input type="radio" name="shippingProvider" value="dhl" id="providerDhl" disabled>
                <div class="provider-content">
                    <div class="provider-logo-img">
                        <img src="/assets/images/providers-logo/dhl-logo.jpg" alt="DHL" class="provider-image">
                    </div>
                    <div class="provider-info">
                        <div class="provider-name">DHL</div>
                        <div class="provider-status disabled">‚ö† Coming Soon</div>
                        <div class="provider-features">Express ‚Ä¢ International</div>
                    </div>
                </div>
            </div>
            
            <!-- UPS - Disabled -->
            <div class="provider-option disabled" data-provider="ups">
                <input type="radio" name="shippingProvider" value="ups" id="providerUps" disabled>
                <div class="provider-content">
                    <div class="provider-logo-img">
                        <img src="/assets/images/providers-logo/ups-logo.webp" alt="UPS" class="provider-image">
                    </div>
                    <div class="provider-info">
                        <div class="provider-name">UPS</div>
                        <div class="provider-status disabled">‚ö† Coming Soon</div>
                        <div class="provider-features">Ground ‚Ä¢ Air ‚Ä¢ International</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sender Information -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <div class="card-title">Sender Information</div>
                <div class="card-subtitle">Your shipping details</div>
            </div>
            <div style="margin-left: auto;">
                <label class="toggle-switch">
                    <input type="checkbox" id="useProfile" checked onchange="toggleProfileData()">
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 8px; font-size: 14px; color: #6b7280;">Use my profile</span>
            </div>
        </div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Full Name *</label>
                <input type="text" id="senderName" value="John Doe" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Company</label>
                <input type="text" id="senderCompany" value="Acme Corporation" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Phone *</label>
                <input type="tel" id="senderPhone" value="+1 (555) 123-4567" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Email *</label>
                <input type="email" id="senderEmail" value="john@acme.com" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div style="grid-column: 1 / -1;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Street Address *</label>
                <input type="text" id="senderAddress" value="123 Business St" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">City *</label>
                <input type="text" id="senderCity" value="New York" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Postal Code *</label>
                <input type="text" id="senderPostalCode" value="10001" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Country *</label>
                <select id="senderCountry" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
                    <option value="United States">United States</option>
                    <option value="United Kingdom" selected>United Kingdom</option>
                    <option value="Germany">Germany</option>
                    <option value="France">France</option>
                    <option value="Italy">Italy</option>
                    <option value="Spain">Spain</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Recipient Information -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div>
                <div class="card-title">Recipient Information</div>
                <div class="card-subtitle">Delivery destination details</div>
            </div>
            <div style="margin-left: auto;">
                <button type="button" class="btn btn-secondary" onclick="loadFromAddressBook()">
                    <i class="fas fa-address-book"></i>
                    Address Book
                </button>
            </div>
        </div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Full Name *</label>
                <input type="text" id="recipientName" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Company</label>
                <input type="text" id="recipientCompany" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Phone *</label>
                <input type="tel" id="recipientPhone" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Email</label>
                <input type="email" id="recipientEmail" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="grid-column: 1 / -1; position: relative;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Street Address *</label>
                <input type="text" id="recipientAddress" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required autocomplete="off">
                <div id="addressSuggestions" class="address-suggestions" style="display: none;"></div>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">City *</label>
                <input type="text" id="recipientCity" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">State/Province</label>
                <input type="text" id="recipientState" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" placeholder="e.g. CA, NY, TX">
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Postal Code *</label>
                <input type="text" id="recipientPostalCode" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div style="position: relative;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Country *</label>
                <input type="text" id="recipientCountryInput" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" placeholder="Search countries..." autocomplete="off">
                <input type="hidden" id="recipientCountry" required>
                <div id="countrySuggestions" class="country-suggestions" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Address Verification Section -->
        <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #3b82f6;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Address Verification</div>
                    <div style="font-size: 14px; color: #6b7280;">Verify recipient address with FedEx to ensure accurate delivery</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="verifyRecipientAddress()" id="verifyAddressBtn">
                    <i class="fas fa-check-circle"></i>
                    Verify Info
                </button>
            </div>
            <div id="addressVerificationResult" style="margin-top: 12px; display: none;"></div>
        </div>
    </div>

    <!-- Package Information -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-box"></i>
            </div>
            <div>
                <div class="card-title">Package Information</div>
                <div class="card-subtitle">Package details and dimensions</div>
            </div>
        </div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Package Type *</label>
                <select id="packageType" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
                    <option value="">Select package type</option>
                    <option value="envelope">Envelope</option>
                    <option value="box">Box</option>
                    <option value="tube">Tube</option>
                    <option value="pallet">Pallet</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Weight (kg) *</label>
                <input type="number" id="packageWeight" min="0.1" step="0.1" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Length (cm) *</label>
                <input type="number" id="packageLength" min="1" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Width (cm) *</label>
                <input type="number" id="packageWidth" min="1" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Height (cm) *</label>
                <input type="number" id="packageHeight" min="1" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;" required>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Declared Value ($)</label>
                <input type="number" id="packageValue" min="0" step="0.01" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
            </div>
            <div style="grid-column: 1 / -1;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Description *</label>
                <textarea id="packageDescription" rows="3" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; resize: vertical;" placeholder="Describe the contents of your package..." required></textarea>
            </div>
        </div>
    </div>

    <!-- Shipping Options -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-shipping-fast"></i>
            </div>
            <div>
                <div class="card-title">FedEx Shipping Options</div>
                <div class="card-subtitle">Real-time rates from FedEx API</div>
            </div>
            <div style="margin-left: auto;">
                <button type="button" class="btn btn-secondary" onclick="calculateRates()">
                    <i class="fas fa-calculator"></i>
                    Get Rates
                </button>
            </div>
        </div>
        <div id="shippingOptions" style="margin-top: 20px;">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <i class="fas fa-calculator" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>Click "Get Rates" to see available shipping options</p>
            </div>
        </div>
    </div>

    <!-- Additional Services -->
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-plus-square"></i>
            </div>
            <div>
                <div class="card-title">Additional Services</div>
                <div class="card-subtitle">Optional add-on services</div>
            </div>
        </div>
        <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 10px;">
                <input type="checkbox" id="insurance" style="width: 18px; height: 18px;">
                <div>
                    <label for="insurance" style="font-weight: 600; color: #374151; cursor: pointer;">Insurance Coverage</label>
                    <div style="font-size: 12px; color: #6b7280;">Protect your package against loss or damage</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 10px;">
                <input type="checkbox" id="signature" style="width: 18px; height: 18px;">
                <div>
                    <label for="signature" style="font-weight: 600; color: #374151; cursor: pointer;">Signature Required</label>
                    <div style="font-size: 12px; color: #6b7280;">Require signature upon delivery</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 10px;">
                <input type="checkbox" id="tracking" style="width: 18px; height: 18px;" checked>
                <div>
                    <label for="tracking" style="font-weight: 600; color: #374151; cursor: pointer;">Real-time Tracking</label>
                    <div style="font-size: 12px; color: #6b7280;">Track your package in real-time</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 10px;">
                <input type="checkbox" id="notifications" style="width: 18px; height: 18px;" checked>
                <div>
                    <label for="notifications" style="font-weight: 600; color: #374151; cursor: pointer;">SMS/Email Notifications</label>
                    <div style="font-size: 12px; color: #6b7280;">Get updates on delivery status</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 0;">
        <button type="button" class="btn btn-secondary" onclick="saveDraft()">
            <i class="fas fa-save"></i>
            Save as Draft
        </button>
        <button type="button" class="btn btn-secondary" onclick="previewShipment()">
            <i class="fas fa-eye"></i>
            Preview
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i>
            Create Shipment
        </button>
    </div>
</form>

<style>
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #032330;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.shipping-option {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.shipping-option:hover {
    border-color: #032330;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(3, 35, 48, 0.1);
}

.shipping-option.selected {
    border-color: #032330;
    background: #f0f9ff;
}

.shipping-option input[type="radio"] {
    display: none;
}

.carrier-logo {
    width: 60px;
    height: 40px;
    background: #f3f4f6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #374151;
    font-size: 12px;
}

/* Provider Selection Styles */
.provider-option {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.provider-option.active {
    border-color: #3b82f6;
    background: #eff6ff;
}

.provider-option.active:hover {
    border-color: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
}

.provider-option.disabled {
    border-color: #e5e7eb;
    background: #f9fafb;
    cursor: not-allowed;
    opacity: 0.6;
}

.provider-option input[type="radio"] {
    display: none;
}

.provider-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.provider-logo-img {
    width: 80px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid #e5e7eb;
    padding: 8px;
    overflow: hidden;
}

.provider-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: brightness(1);
    transition: all 0.3s ease;
}

.provider-option.disabled .provider-image {
    filter: grayscale(100%) opacity(0.5);
}

.provider-option.active .provider-logo-img {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

/* Legacy support for icon-based logos in rate display */
.provider-logo {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.fedex-logo {
    background: linear-gradient(135deg, #4c1d95, #7c3aed);
}

.dhl-logo {
    background: linear-gradient(135deg, #dc2626, #f59e0b);
}

.ups-logo {
    background: linear-gradient(135deg, #92400e, #d97706);
}

.provider-info {
    flex: 1;
}

.provider-name {
    font-size: 18px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 4px;
}

.provider-status.active {
    color: #10b981;
    font-weight: 600;
    font-size: 14px;
}

.provider-status.disabled {
    color: #f59e0b;
    font-weight: 600;
    font-size: 14px;
}

.provider-features {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

/* Address Suggestions Dropdown */
.address-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
}

.suggestion-item:hover {
    background-color: #f8fafc;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-address {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.suggestion-details {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
}

.suggestion-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-left: 8px;
}

.suggestion-badge.business {
    background: #dbeafe;
    color: #1e40af;
}

.suggestion-badge.residential {
    background: #dcfce7;
    color: #166534;
}

.suggestion-loading {
    padding: 12px 16px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
}

.suggestion-empty {
    padding: 12px 16px;
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
}

/* Country Suggestions Dropdown */
.country-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
}

.country-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.country-item:hover {
    background-color: #f8fafc;
}

.country-item:last-child {
    border-bottom: none;
}

.country-flag {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.country-name {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.country-code {
    font-size: 12px;
    color: #6b7280;
    margin-left: auto;
}
</style>

<script>
    // Pass Stripe publishable key from server to client
    window.stripePublishableKey = "<%= stripePublishableKey %>";
</script>

<script>
/**
 * Format currency with proper thousand separators and decimal places
 */
function formatCurrency(amount) {
    if (typeof amount !== 'number') {
        amount = parseFloat(amount) || 0;
    }
    
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

/**
 * Format currency for display with currency symbol
 */
function formatPrice(amount, currency = 'USD') {
    if (typeof amount !== 'number') {
        amount = parseFloat(amount) || 0;
    }
    
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

document.addEventListener('DOMContentLoaded', function() {
    // Pre-fill from URL parameters if coming from rates page
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('from')) {
        document.getElementById('senderAddress').value = urlParams.get('from');
    }
    if (urlParams.get('to')) {
        document.getElementById('recipientAddress').value = urlParams.get('to');
    }
    if (urlParams.get('weight')) {
        document.getElementById('packageWeight').value = urlParams.get('weight');
    }
    
    // Initialize address autocomplete
    initializeAddressAutocomplete();
    
    // Initialize country autocomplete
    initializeCountryAutocomplete();
    
    // Form submission
    document.getElementById('shipmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createShipment();
    });
});

// Country Data with flags and codes
const countries = [
    { name: 'United States', code: 'US', flag: 'üá∫üá∏' },
    { name: 'United Kingdom', code: 'GB', flag: 'üá¨üáß' },
    { name: 'Canada', code: 'CA', flag: 'üá®üá¶' },
    { name: 'Australia', code: 'AU', flag: 'üá¶üá∫' },
    { name: 'Germany', code: 'DE', flag: 'üá©üá™' },
    { name: 'France', code: 'FR', flag: 'üá´üá∑' },
    { name: 'Italy', code: 'IT', flag: 'üáÆüáπ' },
    { name: 'Spain', code: 'ES', flag: 'üá™üá∏' },
    { name: 'Netherlands', code: 'NL', flag: 'üá≥üá±' },
    { name: 'Belgium', code: 'BE', flag: 'üáßüá™' },
    { name: 'Switzerland', code: 'CH', flag: 'üá®üá≠' },
    { name: 'Austria', code: 'AT', flag: 'üá¶üáπ' },
    { name: 'Sweden', code: 'SE', flag: 'üá∏üá™' },
    { name: 'Norway', code: 'NO', flag: 'üá≥üá¥' },
    { name: 'Denmark', code: 'DK', flag: 'üá©üá∞' },
    { name: 'Finland', code: 'FI', flag: 'üá´üáÆ' },
    { name: 'Poland', code: 'PL', flag: 'üáµüá±' },
    { name: 'Czech Republic', code: 'CZ', flag: 'üá®üáø' },
    { name: 'Hungary', code: 'HU', flag: 'üá≠üá∫' },
    { name: 'Portugal', code: 'PT', flag: 'üáµüáπ' },
    { name: 'Greece', code: 'GR', flag: 'üá¨üá∑' },
    { name: 'Ireland', code: 'IE', flag: 'üáÆüá™' },
    { name: 'Luxembourg', code: 'LU', flag: 'üá±üá∫' },
    { name: 'Japan', code: 'JP', flag: 'üáØüáµ' },
    { name: 'South Korea', code: 'KR', flag: 'üá∞üá∑' },
    { name: 'China', code: 'CN', flag: 'üá®üá≥' },
    { name: 'India', code: 'IN', flag: 'üáÆüá≥' },
    { name: 'Brazil', code: 'BR', flag: 'üáßüá∑' },
    { name: 'Mexico', code: 'MX', flag: 'üá≤üáΩ' },
    { name: 'Argentina', code: 'AR', flag: 'üá¶üá∑' },
    { name: 'Chile', code: 'CL', flag: 'üá®üá±' },
    { name: 'Colombia', code: 'CO', flag: 'üá®üá¥' },
    { name: 'Peru', code: 'PE', flag: 'üáµüá™' },
    { name: 'South Africa', code: 'ZA', flag: 'üáøüá¶' },
    { name: 'Egypt', code: 'EG', flag: 'üá™üá¨' },
    { name: 'Israel', code: 'IL', flag: 'üáÆüá±' },
    { name: 'Turkey', code: 'TR', flag: 'üáπüá∑' },
    { name: 'Russia', code: 'RU', flag: 'üá∑üá∫' },
    { name: 'Ukraine', code: 'UA', flag: 'üá∫üá¶' },
    { name: 'Singapore', code: 'SG', flag: 'üá∏üá¨' },
    { name: 'Malaysia', code: 'MY', flag: 'üá≤üáæ' },
    { name: 'Thailand', code: 'TH', flag: 'üáπüá≠' },
    { name: 'Philippines', code: 'PH', flag: 'üáµüá≠' },
    { name: 'Indonesia', code: 'ID', flag: 'üáÆüá©' },
    { name: 'Vietnam', code: 'VN', flag: 'üáªüá≥' },
    { name: 'New Zealand', code: 'NZ', flag: 'üá≥üáø' }
];

// Country Autocomplete Functionality
let countryTimeout;
let currentCountryQuery = '';

function initializeCountryAutocomplete() {
    const countryInput = document.getElementById('recipientCountryInput');
    const countrySuggestions = document.getElementById('countrySuggestions');
    const hiddenCountryInput = document.getElementById('recipientCountry');
    
    // Set default country
    countryInput.value = 'United States';
    hiddenCountryInput.value = 'US';
    
    countryInput.addEventListener('input', function(e) {
        const query = e.target.value.trim().toLowerCase();
        currentCountryQuery = query;
        
        if (countryTimeout) {
            clearTimeout(countryTimeout);
        }
        
        if (query.length === 0) {
            hideCountrySuggestions();
            hiddenCountryInput.value = '';
            return;
        }
        
        countryTimeout = setTimeout(() => {
            showCountrySuggestions(query);
        }, 150);
    });
    
    countryInput.addEventListener('focus', function() {
        if (currentCountryQuery) {
            showCountrySuggestions(currentCountryQuery);
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!countryInput.contains(e.target) && !countrySuggestions.contains(e.target)) {
            hideCountrySuggestions();
        }
    });
}

function showCountrySuggestions(query) {
    const countrySuggestions = document.getElementById('countrySuggestions');
    
    const filteredCountries = countries.filter(country => 
        country.name.toLowerCase().includes(query) || 
        country.code.toLowerCase().includes(query)
    ).slice(0, 8); // Limit to 8 results
    
    if (filteredCountries.length === 0) {
        countrySuggestions.innerHTML = '<div class="suggestion-empty">No countries found</div>';
    } else {
        const suggestionsHTML = filteredCountries.map((country, index) => `
            <div class="country-item" onclick="selectCountry('${country.code}', '${country.name}')">
                <span class="country-flag">${country.flag}</span>
                <span class="country-name">${country.name}</span>
                <span class="country-code">${country.code}</span>
            </div>
        `).join('');
        
        countrySuggestions.innerHTML = suggestionsHTML;
    }
    
    countrySuggestions.style.display = 'block';
}

function selectCountry(code, name) {
    document.getElementById('recipientCountryInput').value = name;
    document.getElementById('recipientCountry').value = code;
    hideCountrySuggestions();
}

function hideCountrySuggestions() {
    document.getElementById('countrySuggestions').style.display = 'none';
}

// Address Autocomplete Functionality
let addressSuggestionTimeout;
let currentSuggestions = [];

function initializeAddressAutocomplete() {
    const addressInput = document.getElementById('recipientAddress');
    const suggestionsDiv = document.getElementById('addressSuggestions');
    
    // Handle input events
    addressInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        if (addressSuggestionTimeout) {
            clearTimeout(addressSuggestionTimeout);
        }
        
        // Hide suggestions if query is too short
        if (query.length < 3) {
            hideSuggestions();
            return;
        }
        
        // Show loading state
        showLoadingSuggestions();
        
        // Debounce API calls
        addressSuggestionTimeout = setTimeout(() => {
            fetchAddressSuggestions(query);
        }, 300);
    });
    
    // Handle focus events
    addressInput.addEventListener('focus', function() {
        if (currentSuggestions.length > 0) {
            suggestionsDiv.style.display = 'block';
        }
    });
    
    // Handle click outside to hide suggestions
    document.addEventListener('click', function(e) {
        if (!addressInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            hideSuggestions();
        }
    });
    
    // Handle keyboard navigation
    addressInput.addEventListener('keydown', function(e) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
        const currentActive = suggestionsDiv.querySelector('.suggestion-item.active');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (currentActive) {
                currentActive.classList.remove('active');
                const next = currentActive.nextElementSibling;
                if (next) {
                    next.classList.add('active');
                } else {
                    suggestions[0]?.classList.add('active');
                }
            } else {
                suggestions[0]?.classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (currentActive) {
                currentActive.classList.remove('active');
                const prev = currentActive.previousElementSibling;
                if (prev) {
                    prev.classList.add('active');
                } else {
                    suggestions[suggestions.length - 1]?.classList.add('active');
                }
            } else {
                suggestions[suggestions.length - 1]?.classList.add('active');
            }
        } else if (e.key === 'Enter') {
            if (currentActive) {
                e.preventDefault();
                selectSuggestion(currentActive.dataset.index);
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });
}

async function fetchAddressSuggestions(query) {
    try {
        // Get country code from hidden input (more reliable)
        const countryCode = document.getElementById('recipientCountry').value || 'US';
        console.log('üìç [DEBUG] Fetching suggestions for:', query, 'in country:', countryCode);
        
        const response = await fetch(`/api/shipments/address-suggestions?query=${encodeURIComponent(query)}&country=${countryCode}`);
        const data = await response.json();
        
        console.log('üìç [DEBUG] API response:', data);
        
        if (data.success) {
            currentSuggestions = data.suggestions || [];
            displaySuggestions(currentSuggestions);
        } else {
            showEmptySuggestions();
        }
    } catch (error) {
        console.error('Error fetching address suggestions:', error);
        showEmptySuggestions();
    }
}

function displaySuggestions(suggestions) {
    const suggestionsDiv = document.getElementById('addressSuggestions');
    
    if (suggestions.length === 0) {
        showEmptySuggestions();
        return;
    }
    
    const suggestionsHTML = suggestions.map((suggestion, index) => {
        const badgeClass = suggestion.classification === 'BUSINESS' ? 'business' : 
                          suggestion.classification === 'RESIDENTIAL' ? 'residential' : '';
        const badge = suggestion.classification !== 'UNKNOWN' ? 
            `<span class="suggestion-badge ${badgeClass}">${suggestion.classification}</span>` : '';
        
        return `
            <div class="suggestion-item" data-index="${index}" onclick="selectSuggestion(${index})">
                <div class="suggestion-address">
                    ${suggestion.address}${badge}
                </div>
                <div class="suggestion-details">
                    ${suggestion.city}, ${suggestion.state} ${suggestion.postalCode}
                </div>
            </div>
        `;
    }).join('');
    
    suggestionsDiv.innerHTML = suggestionsHTML;
    suggestionsDiv.style.display = 'block';
}

function selectSuggestion(index) {
    const suggestion = currentSuggestions[index];
    if (!suggestion) return;
    
    console.log('üìç [DEBUG] Selecting suggestion:', suggestion);
    
    // Fill in the form fields
    if (suggestion.address) {
        document.getElementById('recipientAddress').value = suggestion.address;
        console.log('‚úÖ Filled address:', suggestion.address);
    }
    if (suggestion.city) {
        document.getElementById('recipientCity').value = suggestion.city;
        console.log('‚úÖ Filled city:', suggestion.city);
    }
    if (suggestion.state) {
        document.getElementById('recipientState').value = suggestion.state;
        console.log('‚úÖ Filled state:', suggestion.state);
    }
    if (suggestion.postalCode) {
        document.getElementById('recipientPostalCode').value = suggestion.postalCode;
        console.log('‚úÖ Filled postal code:', suggestion.postalCode);
    }
    
    // Handle country selection - but don't override user's country choice with wrong FedEx data
    if (suggestion.country && suggestion.country !== 'CL') {
        const countryCode = suggestion.country;
        const country = countries.find(c => c.code === countryCode || c.name === countryCode);
        
        if (country) {
            document.getElementById('recipientCountryInput').value = country.name;
            document.getElementById('recipientCountry').value = country.code;
            console.log('‚úÖ Filled country:', country.name, '(' + country.code + ')');
        }
    } else {
        console.log('‚ö†Ô∏è Skipping country auto-fill - wrong country code:', suggestion.country);
    }
    
    // Hide suggestions
    hideSuggestions();
    
    // Show success message with details
    const filledFields = [];
    if (suggestion.address) filledFields.push('address');
    if (suggestion.city) filledFields.push('city');
    if (suggestion.state) filledFields.push('state');
    if (suggestion.postalCode) filledFields.push('postal code');
    if (suggestion.country && suggestion.country !== 'CL') filledFields.push('country');
    
    if (filledFields.length > 0) {
        showNotification(`Auto-filled: ${filledFields.join(', ')} from FedEx!`, 'success');
    } else {
        showNotification('Address suggestion selected', 'info');
    }
}

function showLoadingSuggestions() {
    const suggestionsDiv = document.getElementById('addressSuggestions');
    suggestionsDiv.innerHTML = '<div class="suggestion-loading"><i class="fas fa-spinner fa-spin"></i> Searching addresses...</div>';
    suggestionsDiv.style.display = 'block';
}

function showEmptySuggestions() {
    const suggestionsDiv = document.getElementById('addressSuggestions');
    suggestionsDiv.innerHTML = '<div class="suggestion-empty">No address suggestions found</div>';
    suggestionsDiv.style.display = 'block';
    
    // Hide after 2 seconds
    setTimeout(() => {
        hideSuggestions();
    }, 2000);
}

function hideSuggestions() {
    const suggestionsDiv = document.getElementById('addressSuggestions');
    suggestionsDiv.style.display = 'none';
    currentSuggestions = [];
}

// Provider Selection
function selectProvider(provider) {
    // Remove active class from all providers
    document.querySelectorAll('.provider-option').forEach(option => {
        option.classList.remove('active');
    });
    
    // Add active class to selected provider (only if not disabled)
    const selectedOption = document.querySelector(`[data-provider="${provider}"]`);
    if (!selectedOption.classList.contains('disabled')) {
        selectedOption.classList.add('active');
        document.getElementById(`provider${provider.charAt(0).toUpperCase() + provider.slice(1)}`).checked = true;
        
        // Update UI based on selected provider
        updateUIForProvider(provider);
    }
}

function updateUIForProvider(provider) {
    const shippingTitle = document.querySelector('.card-title');
    const shippingSubtitle = document.querySelector('.card-subtitle');
    
    if (provider === 'fedex') {
        shippingTitle.textContent = 'FedEx Shipping Options';
        shippingSubtitle.textContent = 'Real-time rates from FedEx API';
    } else if (provider === 'dhl') {
        shippingTitle.textContent = 'DHL Shipping Options';
        shippingSubtitle.textContent = 'Coming soon - DHL integration';
    } else if (provider === 'ups') {
        shippingTitle.textContent = 'UPS Shipping Options';
        shippingSubtitle.textContent = 'Coming soon - UPS integration';
    }
}

// Address Verification
async function verifyRecipientAddress() {
    const btn = document.getElementById('verifyAddressBtn');
    const resultDiv = document.getElementById('addressVerificationResult');
    
    // Get recipient address data
    const countryInput = document.getElementById('recipientCountryInput');
    const countryHidden = document.getElementById('recipientCountry');
    
    console.log('üîç [DEBUG] Country field values:');
    console.log('  - Country Input (visible):', countryInput?.value);
    console.log('  - Country Hidden (code):', countryHidden?.value);
    
    const address = {
        address: document.getElementById('recipientAddress').value,
        city: document.getElementById('recipientCity').value,
        state: document.getElementById('recipientState')?.value || '',
        postalCode: document.getElementById('recipientPostalCode').value,
        country: countryHidden?.value || 'US'  // Use country code from hidden field, fallback to US
    };
    
    console.log('üîç [DEBUG] Final address being verified:', address);
    
    // Validate required fields
    if (!address.address || !address.city || !address.postalCode || !address.country) {
        showNotification('Please fill in all recipient address fields before verification', 'warning');
        return;
    }
    
    // Show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/shipments/validate-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ address })
        });
        
        const data = await response.json();
        
        if (data.success && data.validation) {
            const validation = data.validation;
            
            // Update form fields with validated address
            if (validation.formattedAddress) {
                document.getElementById('recipientAddress').value = validation.formattedAddress.address;
                document.getElementById('recipientCity').value = validation.formattedAddress.city;
                document.getElementById('recipientPostalCode').value = validation.formattedAddress.postalCode;
                if (validation.formattedAddress.country) {
                    document.getElementById('recipientCountry').value = validation.formattedAddress.country;
                }
            }
            
            // Show verification result - be more accurate about validation status
            const isActuallyValid = validation.isValid && validation.confidence !== 'NOT_VALIDATED' && validation.classification !== 'UNKNOWN';
            const isPartiallyValid = validation.isValid && (validation.confidence === 'NOT_VALIDATED' || validation.classification === 'UNKNOWN');
            
            let bgColor, iconColor, icon, title, notificationType, notificationMessage;
            
            if (isActuallyValid) {
                bgColor = '#dcfce7';
                iconColor = '#10b981';
                icon = 'fa-check-circle';
                title = 'Address Verified ‚úì';
                notificationType = 'success';
                notificationMessage = 'Address verified successfully with FedEx!';
            } else if (isPartiallyValid) {
                bgColor = '#fef3c7';
                iconColor = '#f59e0b';
                icon = 'fa-exclamation-triangle';
                title = 'Address Validation Incomplete ‚ö†';
                notificationType = 'warning';
                notificationMessage = 'Address could not be fully validated with FedEx';
            } else {
                bgColor = '#fee2e2';
                iconColor = '#ef4444';
                icon = 'fa-times-circle';
                title = 'Address Validation Failed ‚úó';
                notificationType = 'error';
                notificationMessage = 'Address validation failed - please check the address';
            }
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${bgColor}; border-radius: 8px;">
                    <i class="fas ${icon}" style="color: ${iconColor};"></i>
                    <div>
                        <div style="font-weight: 600; color: #374151;">
                            ${title}
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            Classification: ${validation.classification} | Confidence: ${validation.confidence}
                        </div>
                        ${!isActuallyValid ? '<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">You can still proceed, but delivery may be delayed</div>' : ''}
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
            
            showNotification(notificationMessage, notificationType);
        } else {
            throw new Error(data.message || 'Address verification failed');
        }
    } catch (error) {
        console.error('Address verification error:', error);
        resultDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fee2e2; border-radius: 8px;">
                <i class="fas fa-times-circle" style="color: #ef4444;"></i>
                <div>
                    <div style="font-weight: 600; color: #374151;">Verification Failed</div>
                    <div style="font-size: 12px; color: #6b7280;">${error.message}</div>
                </div>
            </div>
        `;
        resultDiv.style.display = 'block';
        showNotification('Address verification failed. Please check the address manually.', 'error');
    } finally {
        // Reset button
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Verify Info';
        btn.disabled = false;
    }
}

function toggleProfileData() {
    const useProfile = document.getElementById('useProfile').checked;
    const senderFields = ['senderName', 'senderCompany', 'senderPhone', 'senderEmail', 'senderAddress'];
    
    senderFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.disabled = useProfile;
        if (useProfile) {
            field.style.background = '#f9fafb';
            field.style.color = '#6b7280';
        } else {
            field.style.background = 'white';
            field.style.color = '#374151';
        }
    });
}

function loadTemplate() {
    // Simulate loading a saved template
    const templates = [
        {
            name: 'Standard Business Package',
            recipientName: 'Jane Smith',
            recipientCompany: 'Tech Solutions Inc',
            recipientPhone: '+1 (555) 987-6543',
            recipientEmail: 'jane@techsol.com',
            recipientAddress: '456 Innovation Dr, San Francisco, CA 94107',
            packageType: 'box',
            packageWeight: '2.5',
            packageLength: '30',
            packageWidth: '20',
            packageHeight: '15',
            packageValue: '500',
            packageDescription: 'Electronic components and documentation'
        }
    ];
    
    const template = templates[0];
    Object.keys(template).forEach(key => {
        const field = document.getElementById(key);
        if (field) {
            field.value = template[key];
        }
    });
    
    showNotification('Template loaded successfully!', 'success');
}

function loadFromAddressBook() {
    // Simulate address book selection
    const addresses = [
        {
            name: 'Sarah Johnson',
            company: 'Global Logistics',
            phone: '+1 (555) 456-7890',
            email: 'sarah@globallog.com',
            address: '789 Commerce St, Chicago, IL 60601'
        },
        {
            name: 'Mike Chen',
            company: 'Retail Express',
            phone: '+1 (555) 321-9876',
            email: 'mike@retailexp.com',
            address: '321 Market Ave, Seattle, WA 98101'
        }
    ];
    
    // For demo, just load the first address
    const address = addresses[0];
    document.getElementById('recipientName').value = address.name;
    document.getElementById('recipientCompany').value = address.company;
    document.getElementById('recipientPhone').value = address.phone;
    document.getElementById('recipientEmail').value = address.email;
    document.getElementById('recipientAddress').value = address.address;
    
    showNotification('Address loaded from address book!', 'success');
}

async function calculateRates() {
    // Check if FedEx is selected
    const selectedProvider = document.querySelector('input[name="shippingProvider"]:checked');
    if (!selectedProvider || selectedProvider.value !== 'fedex') {
        showNotification('Please select FedEx as your shipping provider', 'warning');
        return;
    }
    
    const weight = document.getElementById('packageWeight').value;
    const length = document.getElementById('packageLength').value;
    const width = document.getElementById('packageWidth').value;
    const height = document.getElementById('packageHeight').value;
    const packageType = document.getElementById('packageType').value;
    const packageValue = document.getElementById('packageValue').value;
    
    // Collect structured address data
    const senderAddress = document.getElementById('senderAddress').value;
    const senderCity = document.getElementById('senderCity').value;
    const senderPostalCode = document.getElementById('senderPostalCode').value;
    const senderCountry = document.getElementById('senderCountry').value;
    
    const recipientAddress = document.getElementById('recipientAddress').value;
    const recipientCity = document.getElementById('recipientCity').value;
    const recipientPostalCode = document.getElementById('recipientPostalCode').value;
    const recipientCountry = document.getElementById('recipientCountry').value;
    
    if (!weight || !length || !width || !height || !senderAddress || !senderCity || !senderPostalCode || !senderCountry || 
        !recipientAddress || !recipientCity || !recipientPostalCode || !recipientCountry || !packageType) {
        showNotification('Please fill in all required package information and address fields first', 'warning');
        return;
    }
    
    // Show loading
    const optionsContainer = document.getElementById('shippingOptions');
    optionsContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p style="margin-top: 16px; color: #6b7280;">Fetching real-time FedEx rates...</p></div>';
    
    try {
        // Get state fields
        const senderState = document.getElementById('senderState')?.value || '';
        const recipientState = document.getElementById('recipientState')?.value || '';
        
        // Build request body for FedEx API
        const requestBody = {
            origin: {
                address: senderAddress,
                city: senderCity,
                state: senderState,
                postalCode: senderPostalCode,
                country: senderCountry
            },
            destination: {
                address: recipientAddress,
                city: recipientCity,
                state: recipientState,
                postalCode: recipientPostalCode,
                country: recipientCountry
            },
            weight: parseFloat(weight),
            dimensions: {
                length: parseFloat(length),
                width: parseFloat(width),
                height: parseFloat(height)
            }
        };

        console.log('üì¶ [DEBUG] Fetching FedEx rates with data:', requestBody);

        // Call the new FedEx API endpoint
        console.log('üì¶ [DEBUG] Sending request to /api/shipments/rates:', requestBody);
        
        const response = await fetch('/api/shipments/rates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('üì¶ [DEBUG] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('üì¶ [DEBUG] Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ [DEBUG] Response data:', data);

        if (!data.success) {
            throw new Error(data.message || 'Failed to calculate FedEx rates');
        }

        // Display the real-time FedEx rates
        displayFedExShippingOptions(data.rates);

    } catch (error) {
        console.error('üí• [DEBUG] Rate calculation error:', error);
        console.error('üí• [DEBUG] Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
        });
        
        // Show more detailed error message
        const errorMessage = error.message || 'Unknown error occurred';
        optionsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>Failed to calculate shipping rates</p>
                <p style="font-size: 14px; color: #6b7280; margin: 8px 0;">${errorMessage}</p>
                <button class="btn btn-secondary" onclick="calculateRates()" style="margin-top: 16px;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
    }
}

function displayFedExShippingOptions(rates) {
    const optionsContainer = document.getElementById('shippingOptions');
    
    if (!rates || rates.length === 0) {
        optionsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>No FedEx rates available for this route.</p>
                <p style="font-size: 14px; margin-top: 8px;">Please verify your addresses and try again.</p>
            </div>
        `;
        return;
    }
    
    optionsContainer.innerHTML = rates.map((rate, index) => {
        // Determine icon based on service type
        let serviceIcon = '<i class="fas fa-plane"></i>'; // Default FedEx icon
        if (rate.serviceLevel && rate.serviceLevel.toLowerCase().includes('ground')) {
            serviceIcon = '<i class="fas fa-truck"></i>';
        } else if (rate.serviceLevel && rate.serviceLevel.toLowerCase().includes('overnight')) {
            serviceIcon = '<i class="fas fa-rocket"></i>';
        } else if (rate.serviceLevel && rate.serviceLevel.toLowerCase().includes('express')) {
            serviceIcon = '<i class="fas fa-shipping-fast"></i>';
        }

        return `
            <div class="shipping-option" onclick="selectShippingOption(${index})">
                <input type="radio" name="shippingOption" value="${index}" id="option${index}">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="provider-logo-img" style="width: 60px; height: 40px;">
                            <img src="/assets/images/providers-logo/FedEx-Logo.webp" alt="FedEx" class="provider-image">
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #032330; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                ${rate.serviceLevel || rate.serviceType}
                                <span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                                    <i class="fas fa-wifi"></i> LIVE API
                                </span>
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">
                                Delivery: ${rate.estimatedDays} ${rate.estimatedDelivery ? '‚Ä¢ ' + new Date(rate.estimatedDelivery).toLocaleDateString() : ''}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 700; color: #10b981;">
                            ${rate.currency || 'USD'} $${formatCurrency(rate.cost)}
                        </div>
                        <div style="font-size: 12px; color: #10b981;">Real-time FedEx rate</div>
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; flex-wrap: gap: 8px;">
                    <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Address Validated</span>
                    <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Real-time Tracking</span>
                    <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Insurance Available</span>
                    ${rate.originValidation && rate.originValidation.classification ? 
                        `<span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 11px;">Origin: ${rate.originValidation.classification}</span>` : ''
                    }
                    ${rate.destValidation && rate.destValidation.classification ? 
                        `<span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 11px;">Dest: ${rate.destValidation.classification}</span>` : ''
                    }
                </div>
            </div>
        `;
    }).join('');
    
    // Store rate data for form submission
    window.availableRates = rates;
    
    showNotification(`Found ${rates.length} FedEx shipping options!`, 'success');
}

function displayRealTimeShippingOptions(rates) {
    const optionsContainer = document.getElementById('shippingOptions');
    
    if (!rates || rates.length === 0) {
        optionsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>No shipping rates available for this route.</p>
            </div>
        `;
        return;
    }
    
    optionsContainer.innerHTML = rates.map((rate, index) => {
        const isAvailable = rate.available === true;
        const isMaintenanceMode = rate.maintenanceMode === true;
        const isDHL = rate.carrier === 'DHL';
        
        // Determine icon based on service type
        let serviceIcon = '<i class="fas fa-box"></i>'; // Default icon
        if (rate.service.toLowerCase().includes('express')) {
            serviceIcon = '<i class="fas fa-rocket"></i>';
        } else if (rate.service.toLowerCase().includes('standard')) {
            serviceIcon = '<i class="fas fa-truck"></i>';
        }

        return `
            <div class="shipping-option ${!isAvailable ? 'disabled' : ''}" ${isAvailable ? `onclick="selectShippingOption(${index})"` : ''} style="${!isAvailable ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                <input type="radio" name="shippingOption" value="${index}" id="option${index}" ${!isAvailable ? 'disabled' : ''}>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="carrier-logo" style="background: ${isDHL ? '#dc2626' : isMaintenanceMode ? '#f59e0b' : '#6b7280'}; color: white;">
                            ${serviceIcon}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #032330; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                ${rate.service}
                                ${isDHL && isAvailable && rate.isLive ? 
                                    '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;"><i class="fas fa-wifi"></i> LIVE</span>' : ''
                                }
                                ${isDHL && isAvailable && !rate.isLive && rate.isDynamic ? 
                                    '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;"><i class="fas fa-calculator"></i> ESTIMATED</span>' : ''
                                }
                                ${isMaintenanceMode ? 
                                    '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;"><i class="fas fa-tools"></i> MAINTENANCE</span>' : ''
                                }
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">Delivery: ${rate.deliveryTime}</div>
                            ${isMaintenanceMode ? 
                                `<div style="color: #f59e0b; font-size: 12px;"><i class="fas fa-exclamation-triangle"></i> ${rate.message || 'API integration in development'}</div>` : ''
                            }
                        </div>
                    </div>
                    <div style="text-align: right;">
                        ${isAvailable ? 
                            `<div style="font-size: 24px; font-weight: 700; color: #10b981;">¬£${rate.baseRate.toFixed(2)}</div>` :
                            `<div style="font-size: 16px; font-weight: 600; color: #6b7280;">Unavailable</div>`
                        }
                        ${isAvailable && isDHL && rate.isLive ? '<div style="font-size: 12px; color: #10b981;">Live API rate</div>' : ''}
                        ${isAvailable && isDHL && !rate.isLive && rate.isDynamic ? '<div style="font-size: 12px; color: #3b82f6;">Dynamic estimate</div>' : ''}
                    </div>
                </div>
                ${isAvailable && isDHL ? 
                    `<div style="margin-top: 12px; display: flex; flex-wrap: gap: 8px;">
                        <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Real-time Tracking</span>
                        <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Live GPS</span>
                        <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 11px;">‚úì Insurance Available</span>
                    </div>` : ''
                }
            </div>
        `;
    }).join('');
    
    // Store rate data for form submission
    window.availableRates = rates;
}

function selectShippingOption(index) {
    // Remove previous selections
    document.querySelectorAll('.shipping-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select clicked option
    event.currentTarget.classList.add('selected');
    document.getElementById(`option${index}`).checked = true;
}

function saveDraft() {
    console.log('Saving shipment as draft...');
    showNotification('Shipment saved as draft!', 'success');
}

function previewShipment() {
    console.log('Opening shipment preview...');
    
    // Validate required fields first
    const requiredFields = [
        'senderName', 'senderPhone', 'senderEmail', 'senderAddress',
        'recipientName', 'recipientPhone', 'recipientAddress',
        'packageType', 'packageWeight', 'packageLength', 'packageWidth', 'packageHeight', 'packageDescription'
    ];
    
    let isValid = true;
    const formData = {};
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.style.borderColor = '#ef4444';
            isValid = false;
        } else {
            field.style.borderColor = '#e5e7eb';
            formData[fieldId] = field.value.trim();
        }
    });
    
    if (!isValid) {
        showNotification('Please fill in all required fields before preview', 'error');
        return;
    }
    
    // Get optional fields
    formData.senderCompany = document.getElementById('senderCompany').value.trim();
    formData.recipientCompany = document.getElementById('recipientCompany').value.trim();
    formData.recipientEmail = document.getElementById('recipientEmail').value.trim();
    formData.packageValue = document.getElementById('packageValue').value.trim();
    
    // Get selected shipping option if available
    const selectedOption = document.querySelector('input[name="shippingOption"]:checked');
    let shippingInfo = null;
    if (selectedOption && window.availableRates) {
        const selectedIndex = parseInt(selectedOption.value);
        const selectedRate = window.availableRates[selectedIndex];
        if (selectedRate) {
            shippingInfo = {
                carrier: selectedRate.carrier,
                service: selectedRate.service,
                cost: selectedRate.baseRate.toFixed(2),
                deliveryTime: selectedRate.deliveryTime
            };
        }
    }
    
    // Create and show preview modal
    showPreviewModal(formData, shippingInfo);
}

function showPreviewModal(formData, shippingInfo) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
    `;
    
    modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
            <h3 style="margin: 0; color: #032330; font-size: 20px;">Shipment Preview</h3>
            <button onclick="closePreviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        
        <div style="display: grid; gap: 20px;">
            <!-- Sender Information -->
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Sender Information</h4>
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                    <p style="margin: 4px 0;"><strong>Name:</strong> ${formData.senderName}</p>
                    ${formData.senderCompany ? `<p style="margin: 4px 0;"><strong>Company:</strong> ${formData.senderCompany}</p>` : ''}
                    <p style="margin: 4px 0;"><strong>Phone:</strong> ${formData.senderPhone}</p>
                    <p style="margin: 4px 0;"><strong>Email:</strong> ${formData.senderEmail}</p>
                    <p style="margin: 4px 0;"><strong>Address:</strong> ${formData.senderAddress}</p>
                </div>
            </div>
            
            <!-- Recipient Information -->
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Recipient Information</h4>
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                    <p style="margin: 4px 0;"><strong>Name:</strong> ${formData.recipientName}</p>
                    ${formData.recipientCompany ? `<p style="margin: 4px 0;"><strong>Company:</strong> ${formData.recipientCompany}</p>` : ''}
                    <p style="margin: 4px 0;"><strong>Phone:</strong> ${formData.recipientPhone}</p>
                    ${formData.recipientEmail ? `<p style="margin: 4px 0;"><strong>Email:</strong> ${formData.recipientEmail}</p>` : ''}
                    <p style="margin: 4px 0;"><strong>Address:</strong> ${formData.recipientAddress}</p>
                </div>
            </div>
            
            <!-- Package Information -->
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Package Information</h4>
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                    <p style="margin: 4px 0;"><strong>Type:</strong> ${formData.packageType}</p>
                    <p style="margin: 4px 0;"><strong>Weight:</strong> ${formData.packageWeight} kg</p>
                    <p style="margin: 4px 0;"><strong>Dimensions:</strong> ${formData.packageLength} √ó ${formData.packageWidth} √ó ${formData.packageHeight} cm</p>
                    ${formData.packageValue ? `<p style="margin: 4px 0;"><strong>Declared Value:</strong> $${formData.packageValue}</p>` : ''}
                    <p style="margin: 4px 0;"><strong>Description:</strong> ${formData.packageDescription}</p>
                </div>
            </div>
            
            ${shippingInfo ? `
            <!-- Shipping Information -->
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Shipping Information</h4>
                <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <p style="margin: 4px 0;"><strong>Carrier:</strong> ${shippingInfo.carrier}</p>
                    <p style="margin: 4px 0;"><strong>Service:</strong> ${shippingInfo.service}</p>
                    <p style="margin: 4px 0;"><strong>Cost:</strong> ¬£${shippingInfo.cost}</p>
                    <p style="margin: 4px 0;"><strong>Delivery Time:</strong> ${shippingInfo.deliveryTime}</p>
                </div>
            </div>
            ` : `
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Shipping Information</h4>
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 4px 0; color: #92400e;"><i class="fas fa-exclamation-triangle"></i> Please calculate shipping rates first</p>
                </div>
            </div>
            `}
            
            <!-- Additional Services -->
            <div>
                <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Additional Services</h4>
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                    <p style="margin: 4px 0;"><strong>Insurance:</strong> ${document.getElementById('insurance').checked ? 'Yes' : 'No'}</p>
                    <p style="margin: 4px 0;"><strong>Signature Required:</strong> ${document.getElementById('signature').checked ? 'Yes' : 'No'}</p>
                    <p style="margin: 4px 0;"><strong>Real-time Tracking:</strong> ${document.getElementById('tracking').checked ? 'Yes' : 'No'}</p>
                    <p style="margin: 4px 0;"><strong>Notifications:</strong> ${document.getElementById('notifications').checked ? 'Yes' : 'No'}</p>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button onclick="closePreviewModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Close
            </button>
            <button onclick="proceedFromPreview()" class="btn btn-primary">
                <i class="fas fa-check"></i>
                Looks Good - Create Shipment
            </button>
        </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Store modal reference for closing
    window.currentPreviewModal = modalOverlay;
}

function closePreviewModal() {
    if (window.currentPreviewModal) {
        window.currentPreviewModal.remove();
        window.currentPreviewModal = null;
    }
}

function proceedFromPreview() {
    closePreviewModal();
    // Trigger the form submission
    document.getElementById('shipmentForm').dispatchEvent(new Event('submit'));
}

function createShipment() {
    // Validate required fields
    const requiredFields = [
        'senderName', 'senderPhone', 'senderEmail', 'senderAddress', 'senderCity', 'senderPostalCode', 'senderCountry',
        'recipientName', 'recipientPhone', 'recipientAddress', 'recipientCity', 'recipientPostalCode', 'recipientCountry',
        'packageType', 'packageWeight', 'packageLength', 'packageWidth', 'packageHeight', 'packageDescription'
    ];
    
    let isValid = true;
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.style.borderColor = '#ef4444';
            isValid = false;
        } else {
            field.style.borderColor = '#e5e7eb';
        }
    });
    
    // Check if shipping option is selected
    const selectedOption = document.querySelector('input[name="shippingOption"]:checked');
    if (!selectedOption) {
        showNotification('Please select a shipping option', 'warning');
        return;
    }
    
    if (!isValid) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Collect form data
    const formData = {};
    requiredFields.forEach(fieldId => {
        formData[fieldId] = document.getElementById(fieldId).value.trim();
    });
    
    // Add optional fields
    formData.senderCompany = document.getElementById('senderCompany').value.trim();
    formData.recipientCompany = document.getElementById('recipientCompany').value.trim();
    formData.recipientEmail = document.getElementById('recipientEmail').value.trim();
    formData.packageValue = document.getElementById('packageValue').value.trim();
    
    // Get selected rate data from stored rates
    const selectedIndex = parseInt(selectedOption.value);
    const selectedRate = window.availableRates ? window.availableRates[selectedIndex] : null;
    
    console.log('üîç [DEBUG] Rate selection:', {
        selectedIndex: selectedIndex,
        availableRates: window.availableRates,
        selectedRate: selectedRate,
        selectedRateProperties: selectedRate ? Object.keys(selectedRate) : null
    });
    
    if (selectedRate) {
        formData.selectedCarrier = selectedRate.carrier;
        formData.selectedService = selectedRate.serviceLevel || selectedRate.service;
        // Use FedEx cost or fallback to other rate properties
        formData.shippingCost = parseFloat(selectedRate.cost || selectedRate.totalRate || selectedRate.baseRate).toFixed(2);
        formData.serviceCode = selectedRate.serviceType || selectedRate.serviceCode;
    } else {
        formData.selectedCarrier = 'DHL Express';
        formData.selectedService = 'Express Worldwide';
        formData.shippingCost = '45.99';
    }
    
    console.log('Form data shipping cost:', formData.shippingCost, typeof formData.shippingCost);
    
    // Show loading state
    showNotification('Saving shipment as draft...', 'info');
    
    // Save as draft first
    fetch('/dashboard/api/save-shipment-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Shipment saved as draft successfully!', 'success');
            
            // Store shipment ID for payment
            window.currentShipmentId = data.shipmentId;
            
            // Show payment modal after brief delay
            setTimeout(() => {
                showPaymentModal(formData, selectedRate);
            }, 1000);
        } else {
            showNotification(data.message || 'Failed to save shipment data', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to save shipment data', 'error');
    });
}

function showPaymentModal(formData, selectedRate) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
    `;
    
    // Extract shipping cost with multiple fallbacks
    let shippingCost;
    if (selectedRate) {
        // Try different rate properties that might exist
        shippingCost = selectedRate.totalRate || selectedRate.baseRate || selectedRate.cost || selectedRate.price || selectedRate.amount;
        console.log('üì¶ [DEBUG] Selected rate object:', selectedRate);
        console.log('üì¶ [DEBUG] Available rate properties:', Object.keys(selectedRate));
    } else {
        shippingCost = formData.shippingCost;
    }
    
    // Ensure we have a valid number
    const parsedCost = parseFloat(shippingCost);
    if (isNaN(parsedCost) || parsedCost <= 0) {
        console.error('‚ùå [ERROR] Invalid shipping cost:', shippingCost);
        showNotification('Invalid shipping cost. Please recalculate rates.', 'error');
        return;
    }
    
    const finalShippingCost = parsedCost.toFixed(2);
    const serviceName = selectedRate ? (selectedRate.service || selectedRate.serviceLevel) : formData.selectedService;
    const carrierName = selectedRate ? selectedRate.carrier : formData.selectedCarrier;
    
    // Store payment amount globally for easy access
    window.currentPaymentAmount = parsedCost;
    
    console.log('üí∞ [DEBUG] Payment modal data:', {
        selectedRate: selectedRate,
        rawShippingCost: shippingCost,
        parsedCost: parsedCost,
        finalShippingCost: finalShippingCost,
        storedAmount: window.currentPaymentAmount,
        serviceName: serviceName,
        carrierName: carrierName
    });
    
    modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
            <h3 style="margin: 0; color: #032330; font-size: 20px;">Complete Payment</h3>
            <button onclick="closePaymentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        
        <!-- Order Summary -->
        <div style="margin-bottom: 24px;">
            <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Order Summary</h4>
            <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>From:</span>
                    <span style="font-weight: 500;">${formData.senderName}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>To:</span>
                    <span style="font-weight: 500;">${formData.recipientName}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Service:</span>
                    <span style="font-weight: 500;">${carrierName} - ${serviceName}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Package:</span>
                    <span style="font-weight: 500;">${formData.packageType} (${formData.packageWeight}kg)</span>
                </div>
                <hr style="margin: 12px 0; border: none; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; color: #032330;">
                    <span>Total:</span>
                    <span>¬£${finalShippingCost}</span>
                </div>
            </div>
        </div>
        
        <!-- Payment Methods -->
        <div style="margin-bottom: 24px;">
            <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px; font-weight: 600;">Select Payment Method</h4>
            <div style="display: grid; gap: 12px;">
                <button onclick="processPayment('stripe')" class="payment-btn" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    padding: 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 16px;
                    font-weight: 500;
                " onmouseover="this.style.borderColor='#3b82f6'; this.style.backgroundColor='#eff6ff';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white';">
                    <i class="fab fa-cc-stripe" style="font-size: 24px; color: #635bff;"></i>
                    Pay with Stripe
                </button>
                
                <button onclick="processPayment('paypal')" class="payment-btn" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    padding: 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 16px;
                    font-weight: 500;
                " onmouseover="this.style.borderColor='#0070ba'; this.style.backgroundColor='#f0f8ff';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='white';" disabled>
                    <i class="fab fa-paypal" style="font-size: 24px; color: #0070ba;"></i>
                    Pay with PayPal
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="paymentLoading" style="display: none; text-align: center; padding: 20px;">
            <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 12px; color: #6b7280;">Processing payment...</p>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button onclick="closePaymentModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </button>
        </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Store modal reference for closing
    window.currentPaymentModal = modalOverlay;
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

function closePaymentModal() {
    if (window.currentPaymentModal) {
        window.currentPaymentModal.remove();
        window.currentPaymentModal = null;
    }
}

async function processPayment(method) {
    if (!window.currentShipmentId) {
        showNotification('Shipment ID not found. Please try again.', 'error');
        return;
    }
    
    console.log('Processing payment:', {
        method: method,
        shipmentId: window.currentShipmentId,
        amount: window.currentPaymentAmount,
        amountType: typeof window.currentPaymentAmount
    });
    
    // Show loading state
    const loadingDiv = document.getElementById('paymentLoading');
    const paymentBtns = document.querySelectorAll('.payment-btn');
    
    paymentBtns.forEach(btn => btn.style.display = 'none');
    loadingDiv.style.display = 'block';
    
    try {
        if (method === 'stripe') {
            // Create payment intent
            const response = await fetch('/api/payments/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    shipmentId: window.currentShipmentId,
                    provider: 'stripe',
                    amount: window.currentPaymentAmount
                })
            });
            
            const responseData = await response.json();
            
            if (!responseData.success) {
                throw new Error(responseData.message || 'Failed to create payment');
            }
            
            const { clientSecret } = responseData.data;
            
            if (!clientSecret) {
                throw new Error('No client secret received from server');
            }
            
            // Initialize Stripe Elements
            if (!window.stripePublishableKey || window.stripePublishableKey === 'pk_test_your_stripe_key') {
                throw new Error('Stripe is not properly configured. Please contact support.');
            }
            const stripe = Stripe(window.stripePublishableKey);
            const elements = stripe.elements({
                clientSecret,
                appearance: {
                    theme: 'stripe',
                    variables: {
                        colorPrimary: '#0d6efd',
                        colorBackground: '#ffffff',
                        colorText: '#212529',
                        colorDanger: '#dc3545',
                        fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        spacingUnit: '4px',
                        borderRadius: '4px',
                    },
                },
            });
            
            // Replace payment modal content with Stripe Elements
            const modalContent = document.querySelector('#paymentLoading').parentNode;
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 16px;">
                    <h3 style="margin: 0; color: #032330; font-size: 20px;">Complete Payment</h3>
                    <button onclick="closePaymentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p style="margin: 0; color: #374151;">Amount: <strong>${formatPrice(window.currentPaymentAmount, 'USD')}</strong></p>
                </div>
                
                <div id="stripe-payment-element" style="margin-bottom: 20px;"></div>
                
                <button id="stripe-submit-btn" disabled style="
                    width: 100%;
                    padding: 12px;
                    background: #635bff;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 16px;
                    font-weight: 500;
                    cursor: pointer;
                    opacity: 0.6;
                ">
                    Loading payment form...
                </button>
                
                <div id="payment-status" style="margin-top: 16px;"></div>
            `;
            
            // Wait for DOM to be ready then create and mount payment element
            setTimeout(() => {
                try {
                    const paymentElementContainer = document.getElementById('stripe-payment-element');
                    if (!paymentElementContainer) {
                        throw new Error('Payment element container not found');
                    }
                    
                    const paymentElement = elements.create('payment');
                    
                    // Store payment element globally for confirmation
                    window.currentPaymentElement = paymentElement;
                    
                    paymentElement.mount('#stripe-payment-element');
                    
                    // Handle mounting events
                    paymentElement.on('ready', () => {
                        console.log('Stripe Elements ready');
                        const submitBtn = document.getElementById('stripe-submit-btn');
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.innerHTML = `Pay ${formatPrice(window.currentPaymentAmount, 'USD')}`;
                    });
                    
                    paymentElement.on('change', (event) => {
                        const statusElement = document.getElementById('payment-status');
                        if (event.error) {
                            statusElement.innerHTML = `
                                <div style="color: #dc3545; padding: 12px; background: #f8d7da; border-radius: 4px;">
                                    ${event.error.message}
                                </div>
                            `;
                        } else {
                            statusElement.innerHTML = '';
                        }
                    });
                    
                    paymentElement.on('loaderror', (event) => {
                        console.error('Stripe Elements load error:', event.error);
                        document.getElementById('payment-status').innerHTML = `
                            <div style="color: #dc3545; padding: 12px; background: #f8d7da; border-radius: 4px;">
                                Failed to load payment form: ${event.error.message}
                            </div>
                        `;
                    });
                } catch (error) {
                    console.error('Payment element creation error:', error);
                    document.getElementById('payment-status').innerHTML = `
                        <div style="color: #dc3545; padding: 12px; background: #f8d7da; border-radius: 4px;">
                            Failed to initialize payment form: ${error.message}
                        </div>
                    `;
                }
            }, 200);
            
            // Handle payment submission
            document.getElementById('stripe-submit-btn').addEventListener('click', async function() {
                const submitBtn = this;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Processing...';
                
                try {
                    // Check if payment element is properly mounted
                    if (!window.currentPaymentElement) {
                        throw new Error('Payment form not ready. Please wait and try again.');
                    }
                    
                    const { error, paymentIntent } = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            return_url: `${window.location.origin}/dashboard/tracking?created=true`,
                        },
                        redirect: 'if_required'
                    });
                    
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    if (paymentIntent.status === 'succeeded') {
                        // Update shipment status
                        const updateResponse = await fetch('/dashboard/api/process-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                shipmentId: window.currentShipmentId,
                                paymentMethod: 'stripe',
                                amount: window.currentPaymentAmount
                            })
                        });
                        
                        const updateData = await updateResponse.json();
                        
                        if (updateData.success) {
                            closePaymentModal();
                            showNotification(`Payment successful! Tracking: ${updateData.trackingNumber}`, 'success');
                            
                            // Reset form and redirect
                            document.getElementById('shipmentForm').reset();
                            setTimeout(() => {
                                window.location.href = `/dashboard/tracking?id=${updateData.trackingNumber}`;
                            }, 2000);
                        } else {
                            throw new Error(updateData.message || 'Failed to update shipment');
                        }
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    document.getElementById('payment-status').innerHTML = `
                        <div style="color: #dc3545; padding: 12px; background: #f8d7da; border-radius: 4px;">
                            Payment failed: ${error.message}
                        </div>
                    `;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `Pay ${formatPrice(window.currentPaymentAmount, 'USD')}`;
                }
            });
            
        } else if (method === 'paypal') {
            // Create PayPal order with fixed amount
            const response = await fetch('/api/payments/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    shipmentId: window.currentShipmentId,
                    provider: 'paypal',
                    amount: window.currentPaymentAmount
                })
            });
            
            const responseData = await response.json();
            
            if (!responseData.success) {
                throw new Error(responseData.message || 'Failed to create PayPal order');
            }
            
            // Redirect to PayPal approval URL with fixed amount
            window.location.href = responseData.data.approvalUrl;
        }
        
    } catch (error) {
        console.error('Payment error:', error);
        
        // Hide loading and show buttons again
        loadingDiv.style.display = 'none';
        paymentBtns.forEach(btn => btn.style.display = 'flex');
        
        showNotification('Payment processing failed: ' + error.message, 'error');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Add CSS for loading spinner
const style = document.createElement('style');
style.textContent = `
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #032330;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
