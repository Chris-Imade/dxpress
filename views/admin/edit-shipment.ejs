<!-- Edit Shipment Page -->
<div class="dashboard-card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
            <i class="fas fa-edit"></i>
        </div>
        <div>
            <div class="card-title">Edit Shipment #<%= shipment.trackingId %></div>
            <div class="card-subtitle">Update shipment details and status</div>
        </div>
        <div style="margin-left: auto;">
            <a href="/admin/shipments" style="display: inline-flex; align-items: center; padding: 10px 16px; background: #6b7280; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500; transition: background-color 0.2s;">
                <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>
                Back to Shipments
            </a>
        </div>
    </div>
</div>

<!-- Edit Shipment Form -->
<div class="dashboard-card">
    <div style="padding: 24px;">
      <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div style="background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
          <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
          <%= errorMessage %>
        </div>
      <% } %>
      
      <form action="/admin/shipments/edit/<%= shipment._id %>" method="POST">
        <!-- Customer Information Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-user" style="margin-right: 8px; color: #6b7280;"></i>
                Customer Information
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Name</label>
                    <input type="text" id="customerName" name="customerName" value="<%= shipment.customerName %>" required 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Email</label>
                    <input type="email" id="customerEmail" name="customerEmail" value="<%= shipment.customerEmail %>" required 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
            </div>
        </div>

        <!-- Contact & Delivery Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-phone" style="margin-right: 8px; color: #6b7280;"></i>
                Contact & Delivery
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Phone</label>
                    <input type="tel" id="customerPhone" name="customerPhone" value="<%= shipment.customerPhone %>" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Estimated Delivery Date</label>
                    <input type="date" id="estimatedDelivery" name="estimatedDelivery" 
                           value="<%= shipment.estimatedDelivery ? shipment.estimatedDelivery.toISOString().split('T')[0] : '' %>" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
            </div>
        </div>

        <!-- Shipping Route Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-route" style="margin-right: 8px; color: #6b7280;"></i>
                Shipping Route
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                        <i class="fas fa-map-marker-alt" style="color: #10b981; margin-right: 4px;"></i>
                        Origin Address
                    </label>
                    <input type="text" id="originAddress" name="originAddress" value="<%= typeof shipment.origin === 'object' ? shipment.origin.address : '' %>" required 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease; margin-bottom: 12px;" 
                           onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e5e7eb'" placeholder="Street address">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <input type="text" id="originCity" name="originCity" value="<%= typeof shipment.origin === 'object' ? shipment.origin.city : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="City">
                        <input type="text" id="originPostalCode" name="originPostalCode" value="<%= typeof shipment.origin === 'object' ? shipment.origin.postalCode : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Postal Code">
                        <input type="text" id="originCountry" name="originCountry" value="<%= typeof shipment.origin === 'object' ? shipment.origin.country : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Country">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                        <i class="fas fa-map-marker-alt" style="color: #ef4444; margin-right: 4px;"></i>
                        Destination Address
                    </label>
                    <input type="text" id="destinationAddress" name="destinationAddress" value="<%= typeof shipment.destination === 'object' ? shipment.destination.address : '' %>" required 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease; margin-bottom: 12px;" 
                           onfocus="this.style.borderColor='#ef4444'" onblur="this.style.borderColor='#e5e7eb'" placeholder="Street address">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <input type="text" id="destinationCity" name="destinationCity" value="<%= typeof shipment.destination === 'object' ? shipment.destination.city : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="City">
                        <input type="text" id="destinationPostalCode" name="destinationPostalCode" value="<%= typeof shipment.destination === 'object' ? shipment.destination.postalCode : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Postal Code">
                        <input type="text" id="destinationCountry" name="destinationCountry" value="<%= typeof shipment.destination === 'object' ? shipment.destination.country : '' %>" required 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Country">
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Details Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-box" style="margin-right: 8px; color: #6b7280;"></i>
                Package Details
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Weight (kg)</label>
                    <input type="number" step="0.01" id="weight" name="weight" value="<%= shipment.weight %>" required 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Dimensions (cm)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <input type="number" step="0.01" placeholder="Length" name="length" 
                               value="<%= shipment.dimensions?.length || '' %>" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                               onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                        <input type="number" step="0.01" placeholder="Width" name="width" 
                               value="<%= shipment.dimensions?.width || '' %>" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                               onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                        <input type="number" step="0.01" placeholder="Height" name="height" 
                               value="<%= shipment.dimensions?.height || '' %>" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                               onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Length × Width × Height</small>
                </div>
            </div>
        </div>
        <!-- Package Type & Status Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-clipboard-list" style="margin-right: 8px; color: #6b7280;"></i>
                Package Type & Status
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Package Type</label>
                    <select id="packageType" name="packageType" required 
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.2s ease;" 
                            onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                        <option value="envelope" <%= shipment.packageType === 'envelope' ? 'selected' : '' %>>Envelope</option>
                        <option value="small_box" <%= shipment.packageType === 'small_box' ? 'selected' : '' %>>Small Box</option>
                        <option value="medium_box" <%= shipment.packageType === 'medium_box' ? 'selected' : '' %>>Medium Box</option>
                        <option value="large_box" <%= shipment.packageType === 'large_box' ? 'selected' : '' %>>Large Box</option>
                        <option value="pallet" <%= shipment.packageType === 'pallet' ? 'selected' : '' %>>Pallet</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Status</label>
                    <select id="status" name="status" required 
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; transition: border-color 0.2s ease;" 
                            onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                        <option value="pending" <%= shipment.status === 'pending' ? 'selected' : '' %>>Pending</option>
                        <option value="processing" <%= shipment.status === 'processing' ? 'selected' : '' %>>Processing</option>
                        <option value="in_transit" <%= shipment.status === 'in_transit' ? 'selected' : '' %>>In Transit</option>
                        <option value="delivered" <%= shipment.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                        <option value="cancelled" <%= shipment.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Carrier Name</label>
                    <input type="text" id="carrierName" name="carrierName" value="<%= shipment.carrierName || '' %>" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s ease;" 
                           onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
            </div>
        </div>

        <!-- Additional Notes Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-sticky-note" style="margin-right: 8px; color: #6b7280;"></i>
                Additional Notes
            </h3>
            <textarea id="notes" name="additionalNotes" rows="4" placeholder="Enter any additional notes or special instructions..." 
                      style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical; transition: border-color 0.2s ease;" 
                      onfocus="this.style.borderColor='#032330'" onblur="this.style.borderColor='#e5e7eb'"><%= shipment.additionalNotes || '' %></textarea>
        </div>

        <!-- Special Options Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-shield-alt" style="margin-right: 8px; color: #6b7280;"></i>
                Special Options
            </h3>
            <div style="display: flex; gap: 32px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="isFragile" name="isFragile" <%= shipment.fragile ? 'checked' : '' %> 
                           style="width: 18px; height: 18px; margin-right: 8px; accent-color: #032330;">
                    <span style="font-weight: 600; color: #374151;">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 4px;"></i>
                        Fragile Package
                    </span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="insurance" name="insurance" <%= shipment.insuranceIncluded ? 'checked' : '' %> 
                           style="width: 18px; height: 18px; margin-right: 8px; accent-color: #032330;">
                    <span style="font-weight: 600; color: #374151;">
                        <i class="fas fa-shield-alt" style="color: #10b981; margin-right: 4px;"></i>
                        Insurance Coverage
                    </span>
                </label>
            </div>
        </div>

        <!-- Shipment History Section -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                <i class="fas fa-history" style="margin-right: 8px; color: #6b7280;"></i>
                Shipment History
            </h3>
            <div id="statusHistory" style="margin-bottom: 16px;">
                <% if (shipment.statusHistory && shipment.statusHistory.length > 0) { %>
                    <% shipment.statusHistory.forEach((history, index) => { %>
                        <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 16px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Date & Time</label>
                                    <input type="datetime-local" name="statusHistory[<%= index %>][date]" required 
                                           value="<%= (history.timestamp && !isNaN(new Date(history.timestamp).getTime())) ? new Date(history.timestamp).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16) %>" 
                                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Status</label>
                                    <select name="statusHistory[<%= index %>][status]" required 
                                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="Pending" <%= history.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="Processing" <%= history.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                        <option value="In Transit" <%= history.status === 'In Transit' ? 'selected' : '' %>>In Transit</option>
                                        <option value="Out for Delivery" <%= history.status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
                                        <option value="Delivered" <%= history.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                        <option value="Delayed" <%= history.status === 'Delayed' ? 'selected' : '' %>>Delayed</option>
                                        <option value="Failed Attempt" <%= history.status === 'Failed Attempt' ? 'selected' : '' %>>Failed Attempt</option>
                                        <option value="Cancelled" <%= history.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Location</label>
                                    <input type="text" name="statusHistory[<%= index %>][location]" value="<%= history.location %>" required 
                                           style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                                </div>
                                <div>
                                    <button type="button" class="remove-history" <%= index === 0 ? 'disabled' : '' %> 
                                            style="padding: 12px; background: #fee2e2; border: none; border-radius: 6px; color: #dc2626; cursor: pointer; <%= index === 0 ? 'opacity: 0.5; cursor: not-allowed;' : '' %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <input type="text" name="statusHistory[<%= index %>][note]" value="<%= history.note || '' %>" 
                                       placeholder="Optional notes about this status" 
                                       style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>No status history available</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 24px; border-top: 2px solid #e5e7eb;">
            <a href="/admin/shipments" style="padding: 12px 24px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; color: #374151; text-decoration: none; font-weight: 600; transition: all 0.2s ease;" 
               onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                <i class="fas fa-arrow-left"></i>
                Cancel
            </a>
            <button type="submit" id="submitBtn" style="padding: 12px 32px; background: #032330; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s ease;" 
                    onmouseover="this.style.background='#064e3b'" onmouseout="this.style.background='#032330'">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
      </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', function() {
        // Disable the button
        submitBtn.disabled = true;
        
        // Change button text to show loading
        submitBtn.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 8px;"></span> Saving...';
    });
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
