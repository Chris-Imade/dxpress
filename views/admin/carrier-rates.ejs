<%- include('../partials/admin-header') %>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-calculator"></i>
                    Carrier Rate Management
                </h1>
                <p class="page-subtitle">Manage shipping rates for all carriers</p>
            </div>
        </div>
    </div>

    <!-- Carrier Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="carrierTabs" role="tablist">
                        <% carriers.forEach((carrier, index) => { %>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link <%= index === 0 ? 'active' : '' %>" 
                                    id="<%= carrier %>-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#<%= carrier %>-panel" 
                                    type="button" 
                                    role="tab">
                                <i class="fas fa-truck"></i>
                                <%= carrier.toUpperCase() %>
                                <% if (ratesData[carrier].current) { %>
                                <span class="badge bg-success ms-2">Active</span>
                                <% } else { %>
                                <span class="badge bg-warning ms-2">No Rates</span>
                                <% } %>
                            </button>
                        </li>
                        <% }); %>
                    </ul>
                </div>

                <div class="card-body">
                    <div class="tab-content" id="carrierTabContent">
                        <% carriers.forEach((carrier, index) => { %>
                        <div class="tab-pane fade <%= index === 0 ? 'show active' : '' %>" 
                             id="<%= carrier %>-panel" 
                             role="tabpanel">
                            
                            <!-- Current Active Rates -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <h4>
                                        <i class="fas fa-star text-warning"></i>
                                        Current Active Rates
                                    </h4>
                                    <% if (ratesData[carrier].current) { %>
                                    <div class="alert alert-success">
                                        <strong>Version:</strong> <%= ratesData[carrier].current.version %><br>
                                        <strong>Effective Date:</strong> <%= new Date(ratesData[carrier].current.effectiveDate).toLocaleDateString() %><br>
                                        <strong>Fuel Surcharge:</strong> <%= (ratesData[carrier].current.surcharges.fuelSurchargeRate * 100).toFixed(1) %>%<br>
                                        <strong>Delivery Area Surcharge:</strong> $<%= ratesData[carrier].current.surcharges.deliveryAreaSurcharge %>
                                    </div>

                                    <!-- Current Rates Table -->
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Service Type</th>
                                                    <th>Base Rate</th>
                                                    <th>Weight Rate (per kg)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% for (const [service, baseRate] of ratesData[carrier].current.baseRates) { %>
                                                <tr>
                                                    <td><%= service %></td>
                                                    <td>$<%= baseRate.toFixed(2) %></td>
                                                    <td>$<%= ratesData[carrier].current.weightRates.get(service)?.toFixed(2) || '0.00' %></td>
                                                </tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <% } else { %>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        No active rates configured for <%= carrier.toUpperCase() %>
                                    </div>
                                    <% } %>
                                </div>

                                <div class="col-md-4">
                                    <!-- Quick Actions -->
                                    <div class="card bg-light">
                                        <div class="card-header">
                                            <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-primary btn-sm w-100 mb-2" 
                                                    onclick="showCreateRateModal('<%= carrier %>')">
                                                <i class="fas fa-plus"></i> Create New Rate Version
                                            </button>
                                            <button class="btn btn-info btn-sm w-100 mb-2" 
                                                    onclick="showImportModal('<%= carrier %>')">
                                                <i class="fas fa-upload"></i> Import from CSV
                                            </button>
                                            <% if (ratesData[carrier].current) { %>
                                            <button class="btn btn-warning btn-sm w-100 mb-2" 
                                                    onclick="showEditRateModal('<%= carrier %>', '<%= ratesData[carrier].current._id %>')">
                                                <i class="fas fa-edit"></i> Edit Current Rates
                                            </button>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Rate History -->
                            <div class="row">
                                <div class="col-12">
                                    <h4><i class="fas fa-history"></i> Rate History</h4>
                                    <% if (ratesData[carrier].history.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Version</th>
                                                    <th>Effective Date</th>
                                                    <th>Status</th>
                                                    <th>Created By</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% ratesData[carrier].history.forEach(rate => { %>
                                                <tr>
                                                    <td>
                                                        <strong><%= rate.version %></strong>
                                                        <% if (rate.isActive) { %>
                                                        <span class="badge bg-success ms-1">Active</span>
                                                        <% } %>
                                                    </td>
                                                    <td><%= new Date(rate.effectiveDate).toLocaleDateString() %></td>
                                                    <td>
                                                        <% if (rate.isActive) { %>
                                                        <span class="text-success"><i class="fas fa-check-circle"></i> Active</span>
                                                        <% } else { %>
                                                        <span class="text-muted"><i class="fas fa-pause-circle"></i> Inactive</span>
                                                        <% } %>
                                                    </td>
                                                    <td><%= rate.createdBy?.name || 'System' %></td>
                                                    <td><%= rate.notes || '-' %></td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary" 
                                                                    onclick="viewRateDetails('<%= rate._id %>')">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <% if (!rate.isActive) { %>
                                                            <button class="btn btn-outline-success" 
                                                                    onclick="activateRate('<%= rate._id %>')">
                                                                <i class="fas fa-play"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" 
                                                                    onclick="deleteRate('<%= rate._id %>')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <% } else { %>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No rate history available for <%= carrier.toUpperCase() %>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Rate Modal -->
<div class="modal fade" id="createRateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Rate Version</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createRateForm">
                    <input type="hidden" id="createCarrier" name="carrier">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Version</label>
                            <input type="text" class="form-control" name="version" placeholder="e.g., 2025.1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Effective Date</label>
                            <input type="date" class="form-control" name="effectiveDate" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Optional notes about this rate version"></textarea>
                    </div>

                    <h6>Surcharges</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fuel Surcharge (%)</label>
                            <input type="number" class="form-control" name="fuelSurchargeRate" step="0.1" value="6.0" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Delivery Area Surcharge ($)</label>
                            <input type="number" class="form-control" name="deliveryAreaSurcharge" step="0.01" value="4.50" required>
                        </div>
                    </div>

                    <h6>Service Rates</h6>
                    <div id="serviceRatesContainer">
                        <!-- Dynamic service rate inputs will be added here -->
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="addServiceRate()">
                        <i class="fas fa-plus"></i> Add Service
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createRateVersion()">Create Rate Version</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript for rate management functionality
let serviceRateCounter = 0;

function showCreateRateModal(carrier) {
    document.getElementById('createCarrier').value = carrier;
    document.getElementById('serviceRatesContainer').innerHTML = '';
    serviceRateCounter = 0;
    
    // Add default FedEx services
    if (carrier === 'fedex') {
        addServiceRate('FEDEX_GROUND', '13.40', '3.06');
        addServiceRate('FEDEX_EXPRESS_SAVER', '30.53', '4.56');
        addServiceRate('FEDEX_2_DAY', '45.53', '6.58');
        addServiceRate('STANDARD_OVERNIGHT', '73.38', '10.56');
    }
    
    new bootstrap.Modal(document.getElementById('createRateModal')).show();
}

function addServiceRate(serviceType = '', baseRate = '', weightRate = '') {
    const container = document.getElementById('serviceRatesContainer');
    const html = `
        <div class="row mb-2 service-rate-row" id="serviceRate${serviceRateCounter}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="serviceTypes[]" placeholder="Service Type" value="${serviceType}" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="baseRates[]" placeholder="Base Rate" step="0.01" value="${baseRate}" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="weightRates[]" placeholder="Weight Rate" step="0.01" value="${weightRate}" required>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeServiceRate(${serviceRateCounter})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    serviceRateCounter++;
}

function removeServiceRate(id) {
    document.getElementById(`serviceRate${id}`).remove();
}

async function createRateVersion() {
    const form = document.getElementById('createRateForm');
    const formData = new FormData(form);
    
    // Build rate objects
    const serviceTypes = formData.getAll('serviceTypes[]');
    const baseRateValues = formData.getAll('baseRates[]');
    const weightRateValues = formData.getAll('weightRates[]');
    
    const baseRates = {};
    const weightRates = {};
    
    serviceTypes.forEach((service, index) => {
        baseRates[service] = parseFloat(baseRateValues[index]);
        weightRates[service] = parseFloat(weightRateValues[index]);
    });
    
    const data = {
        carrier: formData.get('carrier'),
        version: formData.get('version'),
        effectiveDate: formData.get('effectiveDate'),
        baseRates: baseRates,
        weightRates: weightRates,
        surcharges: {
            fuelSurchargeRate: parseFloat(formData.get('fuelSurchargeRate')) / 100,
            deliveryAreaSurcharge: parseFloat(formData.get('deliveryAreaSurcharge'))
        },
        notes: formData.get('notes')
    };
    
    try {
        const response = await fetch('/admin/carrier-rates/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Rate version created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createRateModal')).hide();
            location.reload();
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to create rate version', 'error');
        console.error(error);
    }
}

async function activateRate(rateId) {
    if (!confirm('Are you sure you want to activate this rate version? This will deactivate the current active version.')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/carrier-rates/api/${rateId}/activate`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Rate version activated successfully!', 'success');
            location.reload();
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to activate rate version', 'error');
        console.error(error);
    }
}

async function deleteRate(rateId) {
    if (!confirm('Are you sure you want to delete this rate version? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/carrier-rates/api/${rateId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Rate version deleted successfully!', 'success');
            location.reload();
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to delete rate version', 'error');
        console.error(error);
    }
}

function showNotification(message, type) {
    // Simple notification system
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => alert.remove());
    }, 5000);
}
</script>

<%- include('../partials/admin-footer') %>
