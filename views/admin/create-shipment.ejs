<!-- Create Shipment Page -->
<div class="dashboard-card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-plus-circle"></i>
        </div>
        <div>
            <div class="card-title">Create New Shipment</div>
            <div class="card-subtitle">Add a new shipment to the system</div>
        </div>
        <div style="margin-left: auto;">
            <a href="/admin/shipments" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Shipments
            </a>
        </div>
    </div>
</div>

<!-- Shipment Form -->
<div class="dashboard-card">
    <div style="padding: 24px;">
        <form action="/admin/shipments/create" method="POST">
            <!-- Customer Information Section -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Customer Information</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Name *</label>
                        <input 
                            type="text" 
                            name="customerName" 
                            value="<%= formData.customerName || '' %>" 
                            required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Email *</label>
                        <input 
                            type="email" 
                            name="customerEmail" 
                            value="<%= formData.customerEmail || '' %>" 
                            required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Customer Phone</label>
                        <input 
                            type="tel" 
                            name="customerPhone" 
                            value="<%= formData.customerPhone || '' %>"
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                </div>
            </div>

            <!-- Shipping Details Section -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Shipping Details</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Origin *</label>
                        <input 
                            type="text" 
                            name="origin" 
                            id="origin"
                            value="<%= formData.origin || '' %>" 
                            required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Destination *</label>
                        <input 
                            type="text" 
                            name="destination" 
                            id="destination"
                            value="<%= formData.destination || '' %>" 
                            required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Estimated Delivery Date</label>
                        <input 
                            type="date" 
                            name="estimatedDelivery" 
                            value="<%= formData.estimatedDelivery || '' %>"
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                </div>
            </div>

            <!-- Package Information Section -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Package Information</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Weight (kg) *</label>
                        <input 
                            type="number" 
                            step="0.01" 
                            name="weight" 
                            id="weight"
                            value="<%= formData.weight || '' %>" 
                            required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Package Type *</label>
                        <select name="packageType" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="" disabled <%= !formData.packageType ? 'selected' : '' %>>Select package type</option>
                            <option value="Document" <%= formData.packageType === 'Document' ? 'selected' : '' %>>Document</option>
                            <option value="Parcel" <%= formData.packageType === 'Parcel' ? 'selected' : '' %>>Parcel</option>
                            <option value="Freight" <%= formData.packageType === 'Freight' ? 'selected' : '' %>>Freight</option>
                            <option value="Express" <%= formData.packageType === 'Express' ? 'selected' : '' %>>Express</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Status</label>
                        <select name="status" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="Pending" selected>Pending</option>
                            <option value="In Transit">In Transit</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Delayed">Delayed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Carrier Name</label>
                        <input 
                            type="text" 
                            name="carrierName" 
                            id="carrierName"
                            value="<%= formData.carrierName || 'DHL Express' %>"
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Shipping Cost (Â£)</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="number" 
                                step="0.01"
                                name="shippingCost" 
                                id="shippingCost"
                                value="<%= formData.shippingCost || '' %>"
                                style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                                placeholder="0.00"
                            >
                            <button type="button" class="btn btn-secondary" onclick="calculateLiveRates()" style="white-space: nowrap;">
                                <i class="fas fa-calculator"></i>
                                Get Live Rate
                            </button>
                        </div>
                        <small style="color: #6b7280; font-size: 12px;">Click "Get Live Rate" to fetch current DHL API rates</small>
                    </div>
                </div>
                
                <!-- Dimensions -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Dimensions (cm)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 400px;">
                        <input
                            type="number"
                            step="0.01"
                            placeholder="Length"
                            name="length"
                            id="length"
                            value="<%= formData.length || '' %>"
                            style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        />
                        <input
                            type="number"
                            step="0.01"
                            placeholder="Width"
                            name="width"
                            id="width"
                            value="<%= formData.width || '' %>"
                            style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        />
                        <input
                            type="number"
                            step="0.01"
                            placeholder="Height"
                            name="height"
                            id="height"
                            value="<%= formData.height || '' %>"
                            style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s ease;"
                        />
                    </div>
                    <small style="color: #6b7280; font-size: 12px;">Length Ã— Width Ã— Height</small>
                </div>

                <!-- Special Options -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 14px;">Special Options</label>
                    <div style="display: flex; gap: 24px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input 
                                type="checkbox" 
                                name="isFragile" 
                                <%= formData.isFragile ? 'checked' : '' %>
                                style="margin-right: 8px; width: 16px; height: 16px;"
                            >
                            <span style="color: #374151; font-size: 14px;">Fragile</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input 
                                type="checkbox" 
                                name="insurance" 
                                <%= formData.insurance ? 'checked' : '' %>
                                style="margin-right: 8px; width: 16px; height: 16px;"
                            >
                            <span style="color: #374151; font-size: 14px;">Insurance</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Additional Notes Section -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Additional Notes</h4>
                <textarea 
                    name="additionalNotes" 
                    rows="4"
                    placeholder="Enter any additional notes or special instructions..."
                    style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;"
                ><%= formData.additionalNotes || '' %></textarea>
            </div>
            
            <!-- Form Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <a href="/admin/shipments" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
                <button type="submit" id="submitBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Create Shipment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    });
});

async function calculateLiveRates() {
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    const weight = document.getElementById('weight').value;
    const length = document.getElementById('length').value || '20';
    const width = document.getElementById('width').value || '15';
    const height = document.getElementById('height').value || '10';
    
    if (!origin || !destination || !weight) {
        showNotification('Please fill in origin, destination, and weight first', 'warning');
        return;
    }
    
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    
    try {
        // Build query parameters for API call
        const params = new URLSearchParams({
            from: origin,
            to: destination,
            weight: weight,
            length: length,
            width: width,
            height: height,
            packageType: 'box',
            declaredValue: '100'
        });

        console.log('ðŸ“¦ [ADMIN] Fetching live rates with params:', params.toString());

        // Call the API endpoint
        const response = await fetch(`/api/shipping-rates?${params}`);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || 'Failed to calculate rates');
        }

        // Find DHL rate and update form
        const dhlRate = data.rates.find(rate => rate.carrier === 'DHL' && rate.available);
        
        if (dhlRate) {
            document.getElementById('shippingCost').value = dhlRate.baseRate.toFixed(2);
            document.getElementById('carrierName').value = `${dhlRate.carrier} - ${dhlRate.service}`;
            showNotification(`Live DHL rate: Â£${dhlRate.baseRate.toFixed(2)} (${dhlRate.deliveryTime})`, 'success');
        } else {
            // Use fallback rate
            document.getElementById('shippingCost').value = '45.99';
            document.getElementById('carrierName').value = 'DHL Express (Fallback)';
            showNotification('Using fallback rate: Â£45.99 (DHL API unavailable)', 'warning');
        }

    } catch (error) {
        console.error('ðŸ’¥ [ADMIN] Rate calculation error:', error);
        
        // Use fallback rate
        document.getElementById('shippingCost').value = '45.99';
        document.getElementById('carrierName').value = 'DHL Express (Fallback)';
        showNotification('Failed to get live rates. Using fallback: Â£45.99', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Add CSS for animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
