<style>
    /* Show/hide options for same day delivery */
    .show-options {
        display: block !important;
        animation: fadeIn 0.3s ease-in-out;
    }

    .hide-options {
        display: none !important;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- Settings Management Page -->
<div class="dashboard-card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-cog"></i>
        </div>
        <div>
            <div class="card-title">System Settings</div>
            <div class="card-subtitle">Configure shipping rates and system preferences</div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<% if (typeof req !=='undefined' && req.query.success) { %>
    <div
        style="padding: 16px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; margin-bottom: 24px; color: #065f46;">
        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
        Settings updated successfully!
    </div>
    <% } %>

        <% if (typeof req !=='undefined' && req.query.error) { %>
            <div
                style="padding: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; margin-bottom: 24px; color: #991b1b;">
                <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                Error updating settings. Please try again.
            </div>
            <% } %>

                <!-- Shipping Rates Configuration -->
                <div class="dashboard-card">
                    <div style="padding: 24px;">
                        <h3 style="margin: 0 0 8px 0; color: #374151; font-size: 18px; font-weight: 600;">Shipping Rates
                            Configuration</h3>
                        <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 14px;">Configure local shipping rates
                            and delivery options</p>

                        <form action="/admin/settings" method="POST" id="settingsForm">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 32px;">
                                <!-- Base Rates -->
                                <div
                                    style="padding: 20px; border: 2px solid #3b82f6; border-radius: 12px; background: #eff6ff;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                        <div style="display: flex; align-items: center;">
                                            <div
                                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                                <i class="fas fa-truck" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <div>
                                                <h4
                                                    style="margin: 0; color: #374151; font-size: 16px; font-weight: 600;">
                                                    Local Delivery Rates</h4>
                                                <div style="display: flex; align-items: center; margin-top: 4px;">
                                                    <span
                                                        style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 8px;">
                                                        <i class="fas fa-cog" style="margin-right: 4px;"></i>Local Rates
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                        <!-- Base Rate -->
                                        <div class="form-group">
                                            <label for="baseRate"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Base Rate (£)
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                <input type="number" id="baseRate" name="baseRate" step="0.01" min="0"
                                                    value="<%= shippingRates.local.baseRate || '3.99' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Base fee for
                                                all shipments</p>
                                        </div>

                                        <!-- Weight Rate -->
                                        <div class="form-group">
                                            <label for="weightRate"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Rate per kg (£)
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                <input type="number" id="weightRate" name="weightRate" step="0.01"
                                                    min="0" value="<%= shippingRates.local.weightRate || '1.25' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Cost per
                                                kilogram</p>
                                        </div>

                                        <!-- Size Rate -->
                                        <div class="form-group">
                                            <label for="sizeRate"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Rate per m³ (£)
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                <input type="number" id="sizeRate" name="sizeRate" step="0.01" min="0"
                                                    value="<%= shippingRates.local.sizeRate || '25.00' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Cost per
                                                cubic meter</p>
                                        </div>

                                        <!-- Additional Fees -->
                                        <div class="form-group">
                                            <label for="additionalFees"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Additional Fees (£)
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                <input type="number" id="additionalFees" name="additionalFees"
                                                    step="0.01" min="0"
                                                    value="<%= shippingRates.local.additionalFees || '2.99' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Fixed fee per
                                                shipment</p>
                                        </div>

                                        <!-- Minimum Charge -->
                                        <div class="form-group">
                                            <label for="minimumCharge"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Minimum Charge (£)
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                <input type="number" id="minimumCharge" name="minimumCharge" step="0.01"
                                                    min="0" value="<%= shippingRates.local.minimumCharge || '5.99' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Minimum
                                                charge per shipment</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delivery Options -->
                                <div
                                    style="padding: 20px; border: 2px solid #8b5cf6; border-radius: 12px; background: #f5f3ff;">
                                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600;">
                                        Delivery Options</h4>

                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                        <!-- Standard Delivery -->
                                        <div class="form-group">
                                            <label for="standardDeliveryDays"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Standard Delivery (days)
                                            </label>
                                            <input type="text" id="standardDeliveryDays" name="standardDeliveryDays"
                                                value="<%= shippingRates.local.standardDeliveryDays || '2-3' %>"
                                                style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">e.g., 2-3,
                                                3-5, etc.</p>
                                        </div>

                                        <!-- Express Delivery -->
                                        <div class="form-group">
                                            <label for="expressDeliveryDays"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Express Delivery (days)
                                            </label>
                                            <input type="text" id="expressDeliveryDays" name="expressDeliveryDays"
                                                value="<%= shippingRates.local.expressDeliveryDays || '1-2' %>"
                                                style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">e.g., 1-2,
                                                next day, etc.</p>
                                        </div>

                                        <!-- Express Multiplier -->
                                        <div class="form-group">
                                            <label for="expressMultiplier"
                                                style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                Express Price Multiplier
                                            </label>
                                            <div style="position: relative;">
                                                <span
                                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">×</span>
                                                <input type="number" id="expressMultiplier" name="expressMultiplier"
                                                    step="0.1" min="1"
                                                    value="<%= shippingRates.local.expressMultiplier || '1.8' %>"
                                                    style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">e.g., 1.5x,
                                                2x base rate</p>
                                        </div>
                                    </div>

                                    <!-- Same Day Delivery -->
                                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #d1d5db;">
                                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                            <input type="checkbox" id="sameDayDelivery" name="sameDayDelivery"
                                                <%=shippingRates.local.sameDayDelivery ? 'checked' : '' %>
                                            style="margin-right: 8px; width: 16px; height: 16px;">
                                            <label for="sameDayDelivery" style="font-weight: 500; color: #374151;">
                                                Enable Same Day Delivery
                                            </label>
                                        </div>

                                        <div id="sameDayOptions"
                                            class="<%= shippingRates.local.sameDayDelivery ? 'show-options' : 'hide-options' %>">
                                            <div
                                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
                                                <div class="form-group">
                                                    <label for="sameDayCutoff"
                                                        style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                        Order Cut-off Time
                                                    </label>
                                                    <input type="time" id="sameDayCutoff" name="sameDayCutoff"
                                                        value="<%= shippingRates.local.sameDayCutoff || '14:00' %>"
                                                        style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                                    <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">Time
                                                        for same-day cutoff</p>
                                                </div>

                                                <div class="form-group">
                                                    <label for="sameDaySurcharge"
                                                        style="display: block; margin-bottom: 6px; font-size: 13px; color: #4b5563; font-weight: 500;">
                                                        Surcharge (£)
                                                    </label>
                                                    <div style="position: relative;">
                                                        <span
                                                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">£</span>
                                                        <input type="number" id="sameDaySurcharge"
                                                            name="sameDaySurcharge" step="0.01" min="0"
                                                            value="<%= shippingRates.local.sameDaySurcharge || '9.99' %>"
                                                            style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                                    </div>
                                                    <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 12px;">
                                                        Additional fee for same-day</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rate Preview -->
                                <div
                                    style="padding: 20px; border: 2px solid #10b981; border-radius: 12px; background: #ecfdf5;">
                                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; font-weight: 600;">
                                        Rate Preview</h4>
                                    <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 14px;">
                                        Example rates based on current settings (1kg, 20x20x20cm package):
                                    </p>

                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                        <!-- Standard -->
                                        <div
                                            style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #d1fae5;">
                                            <div style="font-size: 14px; color: #4b5563; margin-bottom: 4px;">Standard
                                            </div>
                                            <div style="font-size: 20px; font-weight: 600; color: #065f46;">
                                                £<span id="previewStandard">0.00</span>
                                            </div>
                                            <div style="font-size: 12px; color: #6b7280;">
                                                <%= settings.standardDeliveryDays || '2-3' %> business days
                                            </div>
                                        </div>

                                        <!-- Express -->
                                        <div
                                            style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #d1fae5;">
                                            <div style="font-size: 14px; color: #4b5563; margin-bottom: 4px;">Express
                                            </div>
                                            <div style="font-size: 20px; font-weight: 600; color: #065f46;">
                                                £<span id="previewExpress">0.00</span>
                                            </div>
                                            <div style="font-size: 12px; color: #6b7280;">
                                                <%= settings.expressDeliveryDays || '1-2' %> business days
                                            </div>
                                        </div>

                                        <!-- Same Day (if enabled) -->
                                        <% if (settings.sameDayDelivery) { %>
                                            <div
                                                style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #d1fae5;">
                                                <div style="font-size: 14px; color: #4b5563; margin-bottom: 4px;">Same
                                                    Day</div>
                                                <div style="font-size: 20px; font-weight: 600; color: #065f46;">
                                                    £<span id="previewSameDay">0.00</span>
                                                </div>
                                                <div style="font-size: 12px; color: #6b7280;">
                                                    Same day before <%= settings.sameDayCutoff || '14:00' %>
                                                </div>
                                            </div>
                                            <% } %>
                                    </div>

                                    <!-- Live Rates vs Fallback -->
                                    <div style="margin-top: 12px;">
                                        <% if (settings.useLiveRates) { %>
                                            <span
                                                style="background: #059669; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                                <i class="fas fa-wifi" style="margin-right: 4px;"></i>Live Rates
                                            </span>
                                            <% } else { %>
                                                <span
                                                    style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                                    <i class="fas fa-exclamation-triangle"
                                                        style="margin-right: 4px;"></i>Fallback
                                                </span>
                                                <% } %>
                                    </div>

                                    <p style="margin: 16px 0 0 0; color: #6b7280; font-size: 12px; font-style: italic;">
                                        Note: These are estimated rates. Final rates are calculated based on actual
                                        package details.
                                    </p>
                                </div>

                                <!-- DHL API Integration -->
                                <div
                                    style="margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-plug"
                                            style="font-size: 24px; color: #059669; margin-bottom: 8px;"></i>
                                        <div style="font-weight: 600; color: #059669; margin-bottom: 4px;">DHL API
                                            Integration Active</div>
                                        <div style="font-size: 14px; color: #065f46;">
                                            Base rates are calculated in real-time using DHL's API based on actual
                                            shipment details entered by users.
                                        </div>
                                    </div>
                                </div>


                                <!-- FedEx Settings -->
                                <div
                                    style="padding: 20px; border: 2px solid #fbbf24; border-radius: 12px; background: #fef3c7; opacity: 0.7;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: between; margin-bottom: 16px;">
                                        <div style="display: flex; align-items: center;">
                                            <div
                                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #7c3aed, #6d28d9); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                                <i class="fas fa-plane" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <div>
                                                <h4
                                                    style="margin: 0; color: #374151; font-size: 16px; font-weight: 600;">
                                                    FedEx</h4>
                                                <div style="display: flex; align-items: center; margin-top: 4px;">
                                                    <span
                                                        style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 8px;">
                                                        <i class="fas fa-tools" style="margin-right: 4px;"></i>Under
                                                        Maintenance
                                                    </span>
                                                    <span
                                                        style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                                        <i class="fas fa-times-circle" style="margin-right: 4px;"></i>No
                                                        API
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; text-align: center;">
                                        <i class="fas fa-wrench"
                                            style="font-size: 24px; color: #d97706; margin-bottom: 8px;"></i>
                                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Service Under
                                            Maintenance</div>
                                        <div style="font-size: 14px; color: #a16207;">
                                            FedEx integration is currently being developed. This service will be
                                            available soon with full API integration.
                                        </div>
                                    </div>
                                </div>

                                <!-- UPS Settings -->
                                <div
                                    style="padding: 20px; border: 2px solid #fbbf24; border-radius: 12px; background: #fef3c7; opacity: 0.7;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: between; margin-bottom: 16px;">
                                        <div style="display: flex; align-items: center;">
                                            <div
                                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                                <i class="fas fa-truck" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <div>
                                                <h4
                                                    style="margin: 0; color: #374151; font-size: 16px; font-weight: 600;">
                                                    UPS</h4>
                                                <div style="display: flex; align-items: center; margin-top: 4px;">
                                                    <span
                                                        style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 8px;">
                                                        <i class="fas fa-tools" style="margin-right: 4px;"></i>Under
                                                        Maintenance
                                                    </span>
                                                    <span
                                                        style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                                        <i class="fas fa-times-circle" style="margin-right: 4px;"></i>No
                                                        API
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; text-align: center;">
                                        <i class="fas fa-wrench"
                                            style="font-size: 24px; color: #d97706; margin-bottom: 8px;"></i>
                                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Service Under
                                            Maintenance</div>
                                        <div style="font-size: 14px; color: #a16207;">
                                            UPS integration is currently being developed. This service will be available
                                            soon with full API integration.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                                <button type="button" onclick="resetForm()" class="btn btn-secondary">
                                    <i class="fas fa-undo"></i>
                                    Reset
                                </button>
                                <button type="submit" id="saveBtn" class="btn btn-primary">
                                    <i class="fas fa-save" id="saveIcon"></i>
                                    <span id="saveText">Save Settings</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <script>
                    // Toggle same day delivery options
                    document.addEventListener('DOMContentLoaded', function () {
                        const sameDayCheckbox = document.getElementById('sameDayDelivery');
                        const sameDayOptions = document.getElementById('sameDayOptions');
                        const form = document.getElementById('settingsForm');
                        const saveBtn = document.getElementById('saveBtn');
                        const saveIcon = document.getElementById('saveIcon');
                        const saveText = document.getElementById('saveText');
                        const resetBtn = document.querySelector('button[onclick="resetForm()"]');

                        // Initialize same day options visibility
                        if (sameDayCheckbox && sameDayOptions) {
                            sameDayOptions.style.display = sameDayCheckbox.checked ? 'block' : 'none';

                            // Add change event listener
                            sameDayCheckbox.addEventListener('change', function () {
                                sameDayOptions.style.display = this.checked ? 'block' : 'none';
                                updateRatePreview();
                            });
                        }

                        // Update rate preview when inputs change
                        const rateInputs = [
                            'baseRate', 'weightRate', 'sizeRate', 'additionalFees', 'minimumCharge',
                            'expressMultiplier', 'expressDeliveryDays', 'standardDeliveryDays',
                            'sameDaySurcharge', 'sameDayCutoff', 'sameDayDelivery'
                        ];

                        rateInputs.forEach(inputId => {
                            const input = document.getElementById(inputId);
                            if (input) {
                                input.addEventListener('input', updateRatePreview);
                                input.addEventListener('change', updateRatePreview);
                            }
                        });

                        // Form submission handler
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                e.preventDefault();

                                // Update button state
                                saveBtn.disabled = true;
                                saveIcon.className = 'fas fa-spinner fa-spin';
                                saveText.textContent = 'Saving...';

                                // Submit the form
                                this.submit();
                            });
                        }

                        // Reset form handler
                        if (resetBtn) {
                            resetBtn.addEventListener('click', function () {
                                if (confirm('Are you sure you want to reset all fields to their default values?')) {
                                    const form = document.getElementById('settingsForm');
                                    if (form) form.reset();
                                    updateRatePreview();
                                }
                            });
                        }
                    });

                    // Calculate and update rate preview
                    function updateRatePreview() {
                        // Get all the values from the form
                        const baseRate = parseFloat(document.getElementById('baseRate')?.value) || 3.99;
                        const weightRate = parseFloat(document.getElementById('weightRate')?.value) || 1.25;
                        const sizeRate = parseFloat(document.getElementById('sizeRate')?.value) || 25.00;
                        const additionalFees = parseFloat(document.getElementById('additionalFees')?.value) || 2.99;
                        const minimumCharge = parseFloat(document.getElementById('minimumCharge')?.value) || 5.99;
                        const expressMultiplier = parseFloat(document.getElementById('expressMultiplier')?.value) || 1.8;
                        const sameDaySurcharge = parseFloat(document.getElementById('sameDaySurcharge')?.value) || 9.99;
                        const sameDayEnabled = document.getElementById('sameDayDelivery')?.checked || false;
                        const standardDeliveryDays = document.getElementById('standardDeliveryDays')?.value || '2-3';
                        const expressDeliveryDays = document.getElementById('expressDeliveryDays')?.value || '1-2';
                        const sameDayCutoff = document.getElementById('sameDayCutoff')?.value || '14:00';

                        // Example package: 1kg, 20x20x20cm (0.008 m³)
                        const weight = 1; // 1kg
                        const volume = 0.008; // 0.008 m³ (20x20x20cm)

                        // Calculate base rate for standard delivery
                        let standardRate = baseRate +
                            (weight * weightRate) +
                            (volume * sizeRate) +
                            additionalFees;

                        // Ensure minimum charge
                        standardRate = Math.max(standardRate, minimumCharge);

                        // Calculate express rate (standard rate * multiplier)
                        const expressRate = standardRate * expressMultiplier;

                        // Calculate same day rate (express rate + surcharge)
                        const sameDayRate = sameDayEnabled ? expressRate + sameDaySurcharge : 0;

                        // Update the UI with delivery options and rates
                        const standardRateElement = document.getElementById('previewStandard');
                        const expressRateElement = document.getElementById('previewExpress');
                        const sameDayRateElement = document.getElementById('previewSameDay');
                        const sameDayRow = document.getElementById('sameDayRateRow');

                        if (standardRateElement) {
                            standardRateElement.textContent = `£${standardRate.toFixed(2)}`;
                        }

                        if (expressRateElement) {
                            expressRateElement.textContent = `£${expressRate.toFixed(2)} (${expressDeliveryDays} days)`;
                        }

                        // Show/hide same day delivery based on checkbox
                        if (sameDayRow) {
                            sameDayRow.style.display = sameDayEnabled ? 'table-row' : 'none';
                        }

                        if (sameDayRateElement && sameDayEnabled) {
                            sameDayRateElement.textContent = `£${sameDayRate.toFixed(2)} (Same day before ${sameDayCutoff})`;
                        }

                        // Update the example package details
                        const exampleDetails = document.getElementById('examplePackageDetails');
                        if (exampleDetails) {
                            exampleDetails.textContent = `Example package: ${weight}kg, ${(volume * 1000000).toFixed(0)}cm³ (${(volume * 35.315).toFixed(3)} ft³)`;
                        }

                        // Update the last updated time
                        const lastUpdated = document.getElementById('lastUpdated');
                        if (lastUpdated) {
                            lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                        }
                    }

                    // Form validation
                    function validateForm() {
                        // Validate that express multiplier is >= 1
                        const expressMultiplier = parseFloat(document.getElementById('expressMultiplier')?.value) || 0;
                        if (expressMultiplier < 1) {
                            alert('Express multiplier must be 1 or greater');
                            return false;
                        }

                        // Validate that minimum charge is positive
                        const minimumCharge = parseFloat(document.getElementById('minimumCharge')?.value) || 0;
                        if (minimumCharge < 0) {
                            alert('Minimum charge cannot be negative');
                            return false;
                        }

                        // Validate same day settings if enabled
                        const sameDayEnabled = document.getElementById('sameDayDelivery')?.checked || false;
                        if (sameDayEnabled) {
                            const sameDaySurcharge = parseFloat(document.getElementById('sameDaySurcharge')?.value) || 0;
                            if (sameDaySurcharge < 0) {
                                alert('Same day surcharge cannot be negative');
                                return false;
                            }

                            const sameDayCutoff = document.getElementById('sameDayCutoff')?.value;
                            if (!sameDayCutoff) {
                                alert('Please specify a cutoff time for same day delivery');
                                return false;
                            }
                        }

                        return true;
                    }

                    // Initialize the rate preview when the page loads
                    document.addEventListener('DOMContentLoaded', function () {
                        // Set initial state of same day options
                        const sameDayCheckbox = document.getElementById('sameDayDelivery');
                        const sameDayOptions = document.getElementById('sameDayOptions');
                        if (sameDayCheckbox && sameDayOptions) {
                            sameDayOptions.style.display = sameDayCheckbox.checked ? 'block' : 'none';
                        }

                        // Initial rate preview update
                        updateRatePreview();

                        // Set up form validation on submit
                        const form = document.getElementById('settingsForm');
                        if (form) {
                            form.addEventListener('submit', function (e) {
                                if (!validateForm()) {
                                    e.preventDefault();
                                    return false;
                                }

                                // Show loading state
                                const saveBtn = document.getElementById('saveBtn');
                                const saveIcon = document.getElementById('saveIcon');
                                const saveText = document.getElementById('saveText');

                                if (saveBtn && saveIcon && saveText) {
                                    saveBtn.disabled = true;
                                    saveBtn.style.opacity = '0.7';
                                    saveIcon.className = 'fas fa-spinner fa-spin';
                                    saveText.textContent = 'Saving...';
                                }

                                return true;
                            });
                        }

                        // Auto-hide success/error messages after 5 seconds
                        const successMsg = document.querySelector('[style*="background: #d1fae5"]');
                        const errorMsg = document.querySelector('[style*="background: #fee2e2"]');

                        const hideMessage = (element) => {
                            if (element) {
                                element.style.transition = 'opacity 0.5s ease';
                                element.style.opacity = '0';
                                setTimeout(() => element.remove(), 500);
                            }
                        };

                        if (successMsg) {
                            setTimeout(() => hideMessage(successMsg), 5000);
                        }

                        if (errorMsg) {
                            setTimeout(() => hideMessage(errorMsg), 5000);
                        }
                    });
                </script>